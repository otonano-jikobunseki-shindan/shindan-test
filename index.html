<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="robots" content="noindex,nofollow" />
  <title>開き方のご案内</title>

  <style>
    :root{
      /* 透明ボタン（②）位置：まずは仮。ズレたらここだけ調整 */
      --cta-left: 15%;
      --cta-top:  69%;
      --cta-w:    70%;
      --cta-h:    10%;

      /* 緑帯（①）の位置：index-top.webp（1239x2048）から算出した固定値 */
      --band-top:    23.6%;
      --band-height: 7.3%;

      /* 流れる速さ（①） */
      --marquee-speed: 28s;

      /* 画面中央で見せる最大幅（PCでもスマホっぽく見える） */
      --maxw: 560px;
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      background:#fff;
      min-height:100vh;
      display:grid;
      place-items:center;
      padding: 12px;
    }

    /* 画像の“基準”になるステージ */
    .stage{
      position: relative;
      width: min(var(--maxw), 100%);
    }

    .stage img.bg{
      width:100%;
      height:auto;
      display:block;
      user-select:none;
      -webkit-user-drag:none;
    }

    /* ===== ① 緑帯の無限スクロール ===== */
    .band{
      position:absolute;
      left:0;
      top: var(--band-top);
      width:100%;
      height: var(--band-height);
      overflow:hidden;
      pointer-events:none; /* バンドは触れない（ボタンの邪魔しない） */
    }

    .track{
      height:100%;
      display:flex;
      flex-wrap:nowrap;
      gap:0;
      align-items:stretch;
      width:max-content;
      animation: marqueeLeft var(--marquee-speed) linear infinite;
      will-change: transform;
    }

    .track img{
      height:100%;
      width:auto;
      display:block; /* 隙間対策 */
    }

    /* 左へ流す：2周分並べて -50% で継ぎ目無し */
    @keyframes marqueeLeft{
      0%   { transform: translateX(0); }
      100% { transform: translateX(-50%); }
    }

    /* ===== ② 透明ボタン ===== */
    .cta{
      position:absolute;
      left: var(--cta-left);
      top:  var(--cta-top);
      width: var(--cta-w);
      height: var(--cta-h);

      background: transparent;
      border:0;
      padding:0;
      cursor:pointer;

      /* 見えないけど押せる */
      color: transparent;

      /* 端末で押しやすい最小高（必要なら） */
      min-height: 44px;
    }

    /* トースト（既存機能のまま残す） */
    .toast{
      position:fixed;
      left:50%;
      bottom:16px;
      transform:translateX(-50%);
      background: rgba(255,255,255,0.92);
      color:#222;
      border:1px solid rgba(0,0,0,0.08);
      border-radius:12px;
      padding:10px 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,.08);
      display:none;
      font-size:13px;
      z-index: 9999;
    }
  </style>
</head>

<body>
<script>
  // ★毎回ここだけ更新：Gemini共有URL（ベース）
  const TARGET_URL_BASE = "https://otonano-jikobunseki-shindan.github.io/shindan-test/quiz.html";

  // index.html に付いている ?from=... や ?invite=... を quiz.html へ引き継ぐ
  const TARGET_URL = (() => {
    const u = new URL(TARGET_URL_BASE);
    // index側のクエリを丸ごと引き継ぐ（先頭の ? を含む）
    u.search = location.search || "";
    return u.toString();
  })();

  const ua = navigator.userAgent || "";

  // ---- 判定方針 ----
  // PC：全部OK（即Geminiへ）
  // スマホ：許可するのは以下のみ
  //   - iOS Safari
  //   - iOS Chrome（CriOS）
  //   - Android Chrome（ただしWebView/LINEを除外）
  // それ以外：案内画面

  const isMobile = /Android|iPhone|iPad|iPod/i.test(ua);
  const isIOS = /iPhone|iPad|iPod/i.test(ua);
  const isAndroid = /Android/i.test(ua);

  // アプリ内ブラウザ/埋め込みWebViewの強いシグナル（入ってたら弾く）
  const isInAppStrong =
    /Line\//i.test(ua) ||            // LINE内ブラウザ
    /;\s*wv\)/i.test(ua) ||          // Android WebViewの印
    /Version\/4\.0/i.test(ua);       // Android WebViewでありがち

  // iOS Safari 判定：Safariを含み、他ブラウザ印がない
  const isSafari =
    isIOS &&
    /Safari/i.test(ua) &&
    !/CriOS|FxiOS|EdgiOS|OPiOS|GSA|Line\//i.test(ua);

  // iOS Chrome 判定
  const isChromeIOS = isIOS && /CriOS/i.test(ua);

  // Android Chrome 判定：Chrome/Chromium を含み、かつ WebView/LINE ではない
  const isChromeAndroid =
    isAndroid &&
    /Chrome\/|Chromium\//i.test(ua) &&
    !/Edg|OPR|SamsungBrowser/i.test(ua) &&
    !isInAppStrong;

  const allowOnMobile = (isSafari || isChromeIOS || isChromeAndroid);

  function toast(msg){
    const el = document.getElementById("toast");
    el.textContent = msg;
    el.style.display = "block";
    clearTimeout(window.__t);
    window.__t = setTimeout(()=> el.style.display="none", 1700);
  }

  function makeChromeIntent(url){
    // Android向け：Chrome intent（端末/アプリ側でブロックされることもある）
    const u = new URL(url);
    const fallback = encodeURIComponent(url);
    return `intent://${u.host}${u.pathname}${u.search}#Intent;scheme=https;package=com.android.chrome;S.browser_fallback_url=${fallback};end`;
  }

  async function copyLink(){
    try{
      await navigator.clipboard.writeText(TARGET_URL);
      toast("リンクをコピーしました！");
    }catch(e){
      const ta=document.createElement("textarea");
      ta.value=TARGET_URL; document.body.appendChild(ta);
      ta.select(); document.execCommand("copy"); document.body.removeChild(ta);
      toast("リンクをコピーしました！");
    }
  }

  function openExternal(){
    if (isAndroid) {
      // AndroidはChrome起動を試みる（ブロック時はコピーで逃げる）
      location.href = makeChromeIntent(TARGET_URL);
      return;
    }
    // iOSは強制不可なので、新規タブを試す（だめでもコピーでOK）
    window.open(TARGET_URL, "_blank", "noopener,noreferrer");
  }

  // ✅ ルール適用
  if (!isMobile) {
    // PCは全部OK
    location.replace(TARGET_URL);
  } else if (allowOnMobile) {
    // スマホでも許可されたブラウザはOK
    location.replace(TARGET_URL);
  } else {
    // 案内画面表示（ここに留まる）
    window.__APP__ = { openExternal, copyLink };
  }
</script>

<!-- ここから “見た目だけ” 新デザイン -->
<div class="stage" aria-label="案内画面">
  <img class="bg" src="assets/illust/index-top.webp" alt="開き方のご案内">

  <!-- ① 緑帯：1〜40を隙間なしで無限スクロール -->
  <div class="band" aria-hidden="true">
    <div class="track">
      <!-- 1周目 -->
      <img src="assets/illust/1.png" alt=""><img src="assets/illust/2.png" alt=""><img src="assets/illust/3.png" alt=""><img src="assets/illust/4.png" alt=""><img src="assets/illust/5.png" alt="">
      <img src="assets/illust/6.png" alt=""><img src="assets/illust/7.png" alt=""><img src="assets/illust/8.png" alt=""><img src="assets/illust/9.png" alt=""><img src="assets/illust/10.png" alt="">
      <img src="assets/illust/11.png" alt=""><img src="assets/illust/12.png" alt=""><img src="assets/illust/13.png" alt=""><img src="assets/illust/14.png" alt=""><img src="assets/illust/15.png" alt="">
      <img src="assets/illust/16.png" alt=""><img src="assets/illust/17.png" alt=""><img src="assets/illust/18.png" alt=""><img src="assets/illust/19.png" alt=""><img src="assets/illust/20.png" alt="">
      <img src="assets/illust/21.png" alt=""><img src="assets/illust/22.png" alt=""><img src="assets/illust/23.png" alt=""><img src="assets/illust/24.png" alt=""><img src="assets/illust/25.png" alt="">
      <img src="assets/illust/26.png" alt=""><img src="assets/illust/27.png" alt=""><img src="assets/illust/28.png" alt=""><img src="assets/illust/29.png" alt=""><img src="assets/illust/30.png" alt="">
      <img src="assets/illust/31.png" alt=""><img src="assets/illust/32.png" alt=""><img src="assets/illust/33.png" alt=""><img src="assets/illust/34.png" alt=""><img src="assets/illust/35.png" alt="">
      <img src="assets/illust/36.png" alt=""><img src="assets/illust/37.png" alt=""><img src="assets/illust/38.png" alt=""><img src="assets/illust/39.png" alt=""><img src="assets/illust/40.png" alt="">

      <!-- 2周目（同じ並びをもう1回） -->
      <img src="assets/illust/1.png" alt=""><img src="assets/illust/2.png" alt=""><img src="assets/illust/3.png" alt=""><img src="assets/illust/4.png" alt=""><img src="assets/illust/5.png" alt="">
      <img src="assets/illust/6.png" alt=""><img src="assets/illust/7.png" alt=""><img src="assets/illust/8.png" alt=""><img src="assets/illust/9.png" alt=""><img src="assets/illust/10.png" alt="">
      <img src="assets/illust/11.png" alt=""><img src="assets/illust/12.png" alt=""><img src="assets/illust/13.png" alt=""><img src="assets/illust/14.png" alt=""><img src="assets/illust/15.png" alt="">
      <img src="assets/illust/16.png" alt=""><img src="assets/illust/17.png" alt=""><img src="assets/illust/18.png" alt=""><img src="assets/illust/19.png" alt=""><img src="assets/illust/20.png" alt="">
      <img src="assets/illust/21.png" alt=""><img src="assets/illust/22.png" alt=""><img src="assets/illust/23.png" alt=""><img src="assets/illust/24.png" alt=""><img src="assets/illust/25.png" alt="">
      <img src="assets/illust/26.png" alt=""><img src="assets/illust/27.png" alt=""><img src="assets/illust/28.png" alt=""><img src="assets/illust/29.png" alt=""><img src="assets/illust/30.png" alt="">
      <img src="assets/illust/31.png" alt=""><img src="assets/illust/32.png" alt=""><img src="assets/illust/33.png" alt=""><img src="assets/illust/34.png" alt=""><img src="assets/illust/35.png" alt="">
      <img src="assets/illust/36.png" alt=""><img src="assets/illust/37.png" alt=""><img src="assets/illust/38.png" alt=""><img src="assets/illust/39.png" alt=""><img src="assets/illust/40.png" alt="">
    </div>
  </div>

  <!-- ② 透明ボタン：既存ボタンと同じ機能（openExternal） -->
  <button class="cta" type="button" onclick="__APP__.openExternal()" aria-label="診断スタート"></button>
</div>

<div class="toast" id="toast"></div>
</body>
</html>
