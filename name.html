<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="robots" content="noindex,nofollow">
  <title>ãŠåå‰ã‚’æ•™ãˆã¦ãã ã•ã„</title>

  <style>
    *, *::before, *::after { box-sizing: border-box; }

    body{
      margin:0;
      font-family: system-ui,-apple-system,"Segoe UI","Noto Sans JP","Yu Gothic",sans-serif;
      background:linear-gradient(180deg,#fff7fb,#f3fbff);
      color:#2b2b2b;
    }
    .wrap{max-width:680px;margin:0 auto;padding:24px;}
    .card{
      background:#ffffffcc;
      border-radius:20px;
      padding:24px;
      box-shadow:0 10px 30px rgba(0,0,0,.06);
    }
    h1{font-size:22px;margin:0 0 12px;}
    p{line-height:1.8;margin:0 0 20px;}
    input{
      width:100%;
      padding:14px 16px;
      font-size:16px;
      border-radius:14px;
      border:1px solid #ddd;
    }
    button{
      margin-top:20px;
      width:100%;
      padding:14px;
      font-size:16px;
      font-weight:700;
      border-radius:14px;
      border:none;
      background:linear-gradient(90deg,#a7f3d0,#93c5fd);
      cursor:pointer;
    }
    .note{
      margin-top:12px;
      font-size:13px;
      color:#666;
    }

    /* â˜…è¿½åŠ ï¼šå¾…æ©Ÿç”»é¢ */
    #waiting{
      display:none;
      position:fixed;
      inset:0;
      background:linear-gradient(180deg,#fff7fb,#f3fbff);
      align-items:center;
      justify-content:center;
      text-align:center;
      z-index:9999;
      font-size:18px;
      font-weight:700;
    }
  </style>
</head>

<body>

<div id="waiting">å›ç­”å‡¦ç†ä¸­â€¦</div>

<div class="wrap" id="main">
  <div class="card">
    <h1>ã‚ã¨å°‘ã—ã§ã™ï¼</h1>
<p>
  æ¬¡ã®ãƒšãƒ¼ã‚¸ã§ã€è¨ºæ–­ã®çµæœã‚’è¡¨ç¤ºã—ã¾ã™ã€‚<br>
  è¨ºæ–­çµæœã®æ–‡ç« ã«ãŠåå‰ã‚’å…¥ã‚Œã¦ã€ã‚ãªãŸã ã‘ã®æ–‡ç« ã‚’è¡¨ç¤ºã—ã¾ã™ï¼<br>
  ã‚ãªãŸã®ãŠãªã¾ãˆï¼ˆæ™®æ®µã®å‘¼ã³åã‚„ã€å‘¼ã°ã‚ŒãŸã„åå‰ã§å¤§ä¸ˆå¤«ã§ã™ï¼ï¼‰ã‚’æ•™ãˆã¦ãã ã•ã„ã€‚
</p>


    <input id="nameInput" placeholder="">

    <button onclick="submitName()">çµæœã‚’è¦‹ã‚‹</button>


  </div>
</div>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbz0nSbcIZKV6P3d8NPu1mZKRjVLT2EF6grR5nfc2otxiky6jdaRBiFhskvjoemWUlOn/exec";

async function postGASWithRetry(payloadObj, keepalive=true){
  const maxTry = 5;
  for (let t=1; t<=maxTry; t++){
    try{
      const body = new URLSearchParams();
      body.set("payload", JSON.stringify(payloadObj));

      const res = await fetch(GAS_URL,{
        method:"POST",
        headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},
        body: body.toString(),
        keepalive: !!keepalive
      });

      // GASã¯json_ã§è¿”ã™ã®ã§ textâ†’parse ãŒå®‰å…¨
      const text = await res.text();
      let json = {};
      try{ json = JSON.parse(text); }catch(_){}

      if (json && json.ok === false && json.error === "busy"){
        const wait = Number(json.retryAfterMs || 800);
        await new Promise(r => setTimeout(r, wait + Math.floor(Math.random()*200)));
        continue;
      }
      return json;

    }catch(err){
      if (t === maxTry) throw err;
      const backoff = Math.min(2000, 300 * (2 ** (t-1)));
      await new Promise(r => setTimeout(r, backoff + Math.floor(Math.random()*200)));
    }
  }
}

const params = new URLSearchParams(location.search);
const sessionId = params.get("sid");
const gender = params.get("gender") || "other";

let allDone = {
  name:false,
  answers:false
};

function showWaiting(){
  document.getElementById("main").style.display="none";
  document.getElementById("waiting").style.display="flex";
}

function tryFinish(){
  if (allDone.name && allDone.answers){
    location.href = `result.html?sid=${encodeURIComponent(sessionId)}`;
  }
}

async function submitName(){
  if (!sessionId){
    alert("ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã—ã¦ãã ã•ã„ã€‚");
    location.href = "quiz.html";
    return;
  }

  const name = document.getElementById("nameInput").value.trim();

  // â˜…ã“ã“è¿½åŠ ï¼šæœªå…¥åŠ›ãƒ–ãƒ­ãƒƒã‚¯
  if(!name){
    alert("ãŠåå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ğŸ˜Š");
    return;
  }

  showWaiting();

  try{
    await postGASWithRetry({
      action:"saveName",
      sessionId,
      name,
      answeredAt:new Date().toISOString()
    }, true);

    allDone.name = true;
    tryFinish();
  }catch(_){}
}

  try{
    await postGASWithRetry({
      action:"saveName",
      sessionId,
      name,
      answeredAt:new Date().toISOString()
    }, true);

    allDone.name = true;
    tryFinish();
  }catch(_){}
}

/* quiz æœªé€ä¿¡å›ç­”é€ä¿¡ */
(function resendUnsentAnswers(){
  try{
    const answers = JSON.parse(localStorage.getItem("diag_answers") || "{}");
    const sentMap = JSON.parse(localStorage.getItem("diag_sent") || "{}");
    const sid = localStorage.getItem("diag_sid");

    if (!sid || !answers){
      allDone.answers = true;
      tryFinish();
      return;
    }

    const qids = Object.keys(answers).filter(
      qid => /^Q\d+$/.test(qid) && !sentMap[qid]
    );

    if (qids.length === 0){
      allDone.answers = true;
      tryFinish();
      return;
    }

    (async ()=>{
      for (const qid of qids){
        await postGASWithRetry({
          action:"logAnswersBatch",
          sessionId:sid,
          gender,
          answeredAt:new Date().toISOString(),
          answers:[{qid, opt:answers[qid]}]
        }, true);

        sentMap[qid]=true;
        localStorage.setItem("diag_sent",JSON.stringify(sentMap));
      }

      allDone.answers = true;
      tryFinish();
    })();

  }catch(_){
    allDone.answers = true;
    tryFinish();
  }
})();
</script>
</body>
</html>
