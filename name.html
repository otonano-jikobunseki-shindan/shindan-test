<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="robots" content="noindex,nofollow">
  <title>お名前を教えてください</title>

  <style>
    *, *::before, *::after { box-sizing: border-box; }

    body{
      margin:0;
      font-family: system-ui,-apple-system,"Segoe UI","Noto Sans JP","Yu Gothic",sans-serif;
      background:linear-gradient(180deg,#fff7fb,#f3fbff);
      color:#2b2b2b;
    }
    .wrap{max-width:680px;margin:0 auto;padding:24px;}
    .card{
      background:#ffffffcc;
      border-radius:20px;
      padding:24px;
      box-shadow:0 10px 30px rgba(0,0,0,.06);
    }
    h1{font-size:22px;margin:0 0 12px;}
    p{line-height:1.8;margin:0 0 20px;}
    input{
      width:100%;
      padding:14px 16px;
      font-size:16px;
      border-radius:14px;
      border:1px solid #ddd;
    }
    button{
      margin-top:20px;
      width:100%;
      padding:14px;
      font-size:16px;
      font-weight:700;
      border-radius:14px;
      border:none;
      background:linear-gradient(90deg,#a7f3d0,#93c5fd);
      cursor:pointer;
    }
    .note{
      margin-top:12px;
      font-size:13px;
      color:#666;
    }

    /* ★追加：待機画面 */
    #waiting{
      display:none;
      position:fixed;
      inset:0;
      background:linear-gradient(180deg,#fff7fb,#f3fbff);
      align-items:center;
      justify-content:center;
      text-align:center;
      z-index:9999;
      font-size:18px;
      font-weight:700;
    }
  </style>
</head>

<body>

<div id="waiting">回答処理中…</div>

<div class="wrap" id="main">
  <div class="card">
    <h1>あと少しです！</h1>
    <p>
      次のページで、診断の結果を表示します。<br>
      診断結果の文章に入れて提供するので、<br>
      <strong>あなたのお名前（普段呼ばれているお名前で大丈夫です！）</strong>を教えてください。
    </p>

    <input id="nameInput" placeholder="（空欄でも大丈夫です）">

    <button onclick="submitName()">結果を見る</button>

    <div class="note">
      ※ 未入力の場合、結果文中では「あなた」と表示されます。
    </div>
  </div>
</div>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbz0nSbcIZKV6P3d8NPu1mZKRjVLT2EF6grR5nfc2otxiky6jdaRBiFhskvjoemWUlOn/exec";

const params = new URLSearchParams(location.search);
const sessionId = params.get("sid");
const gender = params.get("gender") || "other";

let allDone = {
  name:false,
  answers:false
};

function showWaiting(){
  document.getElementById("main").style.display="none";
  document.getElementById("waiting").style.display="flex";
}

function tryFinish(){
  if (allDone.name && allDone.answers){
    location.href = `result.html?sid=${encodeURIComponent(sessionId)}`;
  }
}

async function submitName(){
  if (!sessionId){
    alert("セッション情報が見つかりませんでした。最初からやり直してください。");
    location.href = "quiz.html";
    return;
  }

  showWaiting();

  const name = document.getElementById("nameInput").value.trim();

  try{
    const payloadObj = {
      action:"saveName",
      sessionId,
      name,
      answeredAt:new Date().toISOString()
    };

    const body = new URLSearchParams();
    body.set("payload", JSON.stringify(payloadObj));

    await fetch(GAS_URL,{
      method:"POST",
      headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},
      body: body.toString(),
      keepalive:true
    });

    allDone.name = true;
    tryFinish();
  }catch(_){}
}

/* quiz 未送信回答送信 */
(function resendUnsentAnswers(){
  try{
    const answers = JSON.parse(localStorage.getItem("diag_answers") || "{}");
    const sentMap = JSON.parse(localStorage.getItem("diag_sent") || "{}");
    const sid = localStorage.getItem("diag_sid");

    if (!sid || !answers){
      allDone.answers = true;
      tryFinish();
      return;
    }

    const qids = Object.keys(answers).filter(
      qid => /^Q\d+$/.test(qid) && !sentMap[qid]
    );

    if (qids.length === 0){
      allDone.answers = true;
      tryFinish();
      return;
    }

    (async ()=>{
      for (const qid of qids){
        const body = new URLSearchParams();
        body.set("payload", JSON.stringify({
          action:"logAnswersBatch",
          sessionId:sid,
          gender,
          answeredAt:new Date().toISOString(),
          answers:[{qid, opt:answers[qid]}]
        }));

        await fetch(GAS_URL,{
          method:"POST",
          headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},
          body: body.toString(),
          keepalive:true
        });

        sentMap[qid]=true;
        localStorage.setItem("diag_sent",JSON.stringify(sentMap));
      }

      allDone.answers = true;
      tryFinish();
    })();

  }catch(_){
    allDone.answers = true;
    tryFinish();
  }
})();
</script>
</body>
</html>
