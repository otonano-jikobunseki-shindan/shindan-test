<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="robots" content="noindex,nofollow" />
  <title>大人の診断テスト</title>
  <style>
    :root{
      --bg:#0b1020; --card:#121a33; --muted:#93a4c7; --text:#eaf0ff;
      --accent:#7c3aed; --accent2:#22c55e; --danger:#ef4444; --line:#243055;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Yu Gothic", sans-serif;background:linear-gradient(180deg,#0b1020,#070a14);color:var(--text);}
    a{color:inherit}
    .wrap{max-width:760px;margin:0 auto;padding:18px 14px 40px;}
    .hero{padding:18px 16px;border:1px solid var(--line);border-radius:16px;background:rgba(18,26,51,.72);backdrop-filter: blur(8px);}
    h1{font-size:22px;margin:0 0 8px;}
    .sub{color:var(--muted);line-height:1.6;margin:0}
    .card{margin-top:14px;padding:16px;border:1px solid var(--line);border-radius:16px;background:rgba(18,26,51,.72);}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .btn{
      appearance:none;border:1px solid var(--line);background:#0f1733;color:var(--text);
      padding:12px 14px;border-radius:12px;font-weight:700;cursor:pointer;flex:1;min-width:140px;
    }
    .btn:hover{border-color:#3b4a7a}
    .btn.primary{background:linear-gradient(90deg,var(--accent),#4f46e5);border-color:transparent;}
    .btn.good{background:linear-gradient(90deg,var(--accent2),#16a34a);border-color:transparent;}
    .btn.ghost{background:transparent}
    .btn.danger{background:rgba(239,68,68,.12);border-color:rgba(239,68,68,.35);}
    .label{font-size:12px;color:var(--muted);margin:0 0 8px}
    .progress{height:10px;background:#0a0f22;border:1px solid var(--line);border-radius:999px;overflow:hidden}
    .bar{height:100%;width:0%;background:linear-gradient(90deg,var(--accent),#22c55e);transition:width .25s}
    .qtitle{font-size:16px;font-weight:800;margin:0 0 10px;line-height:1.5}
    .opt{display:block;width:100%;text-align:left;margin:10px 0;padding:12px 12px;border-radius:12px;border:1px solid var(--line);background:#0f1733;color:var(--text);cursor:pointer}
    .opt:hover{border-color:#3b4a7a}
    .tiny{font-size:12px;color:var(--muted);line-height:1.6}
    .field{width:100%;padding:12px;border-radius:12px;border:1px solid var(--line);background:#0f1733;color:var(--text);font-size:16px}
    .hr{height:1px;background:var(--line);margin:14px 0}
    .pill{display:inline-block;padding:6px 10px;border:1px solid var(--line);border-radius:999px;color:var(--muted);font-size:12px}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    .err{color:#fecaca;background:rgba(239,68,68,.10);border:1px solid rgba(239,68,68,.35);padding:10px;border-radius:12px;margin-top:10px}
    .ok{color:#bbf7d0;background:rgba(34,197,94,.10);border:1px solid rgba(34,197,94,.35);padding:10px;border-radius:12px;margin-top:10px}
    .mutedBox{border:1px dashed var(--line);border-radius:12px;padding:10px;color:var(--muted);line-height:1.7}
    .sectionTitle{font-size:16px;margin:0 0 6px;font-weight:900}
    .pre{white-space:pre-wrap;line-height:1.8}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="hero">
      <h1>あなたの特性が笑っちゃうほどわかる！大人の診断テスト！</h1>
      <p class="sub">5分以内で回答できる！現在、完全無料で診断できます。</p>
      <p class="sub tiny">※このページはスマホ前提で作っていますが、PCでも表示可能です。</p>
    </div>

    <div id="app" class="card"></div>

    <div class="card">
      <div class="label">デバッグ表示（必要なときだけ見る用）</div>
      <div class="mutedBox tiny">
        sessionId: <span id="dbgSid" class="mono"></span><br/>
        step: <span id="dbgStep" class="mono"></span>
      </div>
    </div>
  </div>

<script>
/* =========================
   設定
========================= */
const GAS_URL = "https://script.google.com/macros/s/AKfycbz0nSbcIZKV6P3d8NPu1mZKRjVLT2EF6grR5nfc2otxiky6jdaRBiFhskvjoemWUlOn/exec";

// GAS側のaction名（あなたの実装に合わせて調整）
const ACTIONS = {
  LOG: "logAnswer",     // 1問ごと記録（※GASが対応していない場合は失敗しても続行）
  FINALIZE: "finalize", // 結果確定
  EMAIL: "email"        // メール送信
};

// TSVファイル
const TSV_PATH = {
  male: "data/male_questions.tsv",
  female: "data/female_questions.tsv" // 女性＋その他はこれ
};

// localStorage keys
const LS = {
  gender: "diag_gender",
  sid: "diag_sid",
  answers: "diag_answers",
  progress: "diag_progress"
};

// 仕様：結果表示後は「次回アクセスで最初から」にしたい
// → 結果を受け取った瞬間に localStorage を消す（ただし、結果画面のメール送信用にsidはメモリに残す）
let runtime = {
  step: "landing",
  sid: "",
  gender: "",
  questions: [],
  idx: 0,
  answers: {},      // Q1..Q50: OPTx / MBTI1..4: 値
  result: null,     // finalize結果JSON
  name: "あなた"    // 画面用（サニタイズはGAS側でもやる前提）
};

const $app = document.getElementById("app");
const $dbgSid = document.getElementById("dbgSid");
const $dbgStep = document.getElementById("dbgStep");

/* =========================
   ユーティリティ
========================= */
function setStep(step){ runtime.step = step; render(); }
function escapeHTML(s){
  return String(s ?? "")
    .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;").replace(/'/g,"&#39;");
}
function nowISO(){ return new Date().toISOString(); }

// sessionId生成（十分にユニークならOK）
function newSessionId(){
  if (crypto?.randomUUID) return crypto.randomUUID();
  return "sid_" + Date.now() + "_" + Math.random().toString(16).slice(2);
}

function loadLS(){
  const sid = localStorage.getItem(LS.sid);
  const gender = localStorage.getItem(LS.gender);
  const answersRaw = localStorage.getItem(LS.answers);
  const progressRaw = localStorage.getItem(LS.progress);

  if (sid) runtime.sid = sid;
  if (gender) runtime.gender = gender;

  if (answersRaw){
    try{ runtime.answers = JSON.parse(answersRaw) || {}; }catch(_){}
  }
  if (progressRaw){
    try{
      const p = JSON.parse(progressRaw) || {};
      runtime.idx = Number(p.idx || 0);
    }catch(_){}
  }
}

function saveLS(){
  localStorage.setItem(LS.sid, runtime.sid);
  localStorage.setItem(LS.gender, runtime.gender);
  localStorage.setItem(LS.answers, JSON.stringify(runtime.answers || {}));
  localStorage.setItem(LS.progress, JSON.stringify({ idx: runtime.idx, savedAt: nowISO() }));
}

// 仕様：結果表示後に次回新規にする
function clearLSAfterResult(){
  localStorage.removeItem(LS.gender);
  localStorage.removeItem(LS.sid);
  localStorage.removeItem(LS.answers);
  localStorage.removeItem(LS.progress);
}

// TSV読み込み
async function loadTSV(path){
  const res = await fetch(path, { cache:"no-store" });
  if (!res.ok) throw new Error(`TSV読込に失敗: ${path}`);
  const text = await res.text();
  return parseTSV(text);
}

// TSVパーサ（シンプル）
function parseTSV(tsv){
  const lines = tsv.replace(/\r/g,"").split("\n").filter(l => l.trim() !== "");
  if (lines.length < 2) return [];
  const header = lines[0].split("\t").map(s=>s.trim());
  const rows = [];
  for (let i=1;i<lines.length;i++){
    const cols = lines[i].split("\t");
    const obj = {};
    for (let c=0;c<header.length;c++){
      obj[header[c]] = (cols[c] ?? "").trim();
    }
    rows.push(obj);
  }
  return rows;
}

// OPT整形（GAS側も normalizeOpt してる想定）
function optStr(n){ return "OPT" + String(n); }

// GASへPOST
async function postGAS(payload){
  const res = await fetch(GAS_URL, {
    method:"POST",
    headers: { "Content-Type":"application/json" },
    body: JSON.stringify(payload)
  });
  const text = await res.text();
  let json;
  try{ json = JSON.parse(text); }catch(_){ throw new Error("GAS応答がJSONではありません"); }
  return json;
}

/* =========================
   初期化
========================= */
async function init(){
  loadLS();

  // sidがなければ発行
  if (!runtime.sid) runtime.sid = newSessionId();

  // 初期ステップ決定
  // 統合版なので index不要。ここで性別未選択なら gender ステップへ。
  runtime.step = "landing";

  render();
}
init();

/* =========================
   画面：レンダリング
========================= */
function render(){
  $dbgSid.textContent = runtime.sid || "";
  $dbgStep.textContent = runtime.step || "";

  if (runtime.step === "landing") return renderLanding();
  if (runtime.step === "gender") return renderGender();
  if (runtime.step === "quiz") return renderQuiz();
  if (runtime.step === "name") return renderName();
  if (runtime.step === "result") return renderResult();
}

function renderLanding(){
  $app.innerHTML = `
    <div class="label">まずはスタート</div>
    <p class="sub">いくつかの質問に答えるだけで、あなたの傾向をスパッと整理します。</p>
    <div class="hr"></div>
    <button class="btn primary" id="btnStart">診断をはじめる</button>
    <p class="tiny" style="margin-top:10px;">
      ※「途中保存の削除ボタン」は置きません。<br/>
      ※結果まで到達したら、次回アクセス時は自動で最初からになります。
    </p>
  `;
  document.getElementById("btnStart").onclick = () => {
    // 性別が保存されていればスキップも可能だが、今回は毎回しっかり導線に乗せる
    setStep("gender");
  };
}

function renderGender(){
  $app.innerHTML = `
    <div class="label">質問 0 / 性別</div>
    <p class="qtitle">あなたはどれですか？</p>
    <div class="row">
      <button class="btn" id="gMale">男性</button>
      <button class="btn" id="gFemale">女性</button>
      <button class="btn" id="gOther">その他</button>
    </div>
    <p class="tiny" style="margin-top:10px;">
      ※「その他」は女性と同じ質問に進みます。<br/>
      ※それ以外の目的で性別を使用しません。
    </p>
  `;

  document.getElementById("gMale").onclick = () => startQuizWithGender("male");
  document.getElementById("gFemale").onclick = () => startQuizWithGender("female");
  document.getElementById("gOther").onclick = () => startQuizWithGender("female"); // 仕様
}

async function startQuizWithGender(gender){
  runtime.gender = gender;
  runtime.idx = 0;
  runtime.answers = {};
  runtime.result = null;
  saveLS();

  try{
    runtime.questions = await loadTSV(gender === "male" ? TSV_PATH.male : TSV_PATH.female);
  }catch(err){
    $app.innerHTML = `<div class="err">TSV読込エラー: ${escapeHTML(err.message)}</div>
      <div class="hr"></div>
      <button class="btn ghost" id="back">戻る</button>`;
    document.getElementById("back").onclick = () => setStep("gender");
    return;
  }

  setStep("quiz");
}

function renderQuiz(){
  const qTotal = runtime.questions.length || 0;
  const idx = runtime.idx;

  if (!qTotal){
    $app.innerHTML = `
      <div class="err">質問データが空です。TSVの中身を確認してください。</div>
      <div class="hr"></div>
      <button class="btn ghost" id="back">性別選択に戻る</button>
    `;
    document.getElementById("back").onclick = () => setStep("gender");
    return;
  }

  // idxが最後を超えたら送信へ
  if (idx >= qTotal){
    $app.innerHTML = `
      <div class="label">回答完了</div>
      <p class="qtitle">最後に、送信して結果に進みます。</p>
      <button class="btn good" id="btnSubmit">回答を送信！</button>
      <p class="tiny" style="margin-top:10px;">
        ※送信後、おなまえ入力に進みます（未入力なら「あなた」になります）。
      </p>
    `;
    document.getElementById("btnSubmit").onclick = () => setStep("name");
    return;
  }

  const q = runtime.questions[idx];

  // TSVの想定：QID / 質問文 / 選択肢1..n の形が多いので、柔軟に拾う
  const qid = q.QID || q.qid || `Q${idx+1}`;
  const text = q["質問文"] || q["question"] || q["Question"] || q["質問"] || "";
  const opts = [];

  // 選択肢列（選択肢1..6など）を拾う
  for (let i=1;i<=10;i++){
    const key = `選択肢${i}`;
    if (q[key] != null && String(q[key]).trim() !== "") opts.push({ label: String(q[key]).trim(), opt: optStr(i) });
  }

  // もし選択肢が拾えない場合、OPT列など別形式も想定してフォールバック（最低限）
  if (!opts.length){
    // 例：OPT1..OPT6 形式
    for (let i=1;i<=10;i++){
      const key = `OPT${i}`;
      if (q[key] != null && String(q[key]).trim() !== "") opts.push({ label: String(q[key]).trim(), opt: optStr(i) });
    }
  }

  const answered = runtime.answers[qid];

  const pct = Math.round((idx / qTotal) * 100);

  $app.innerHTML = `
    <div class="row" style="justify-content:space-between;align-items:center;">
      <span class="pill">進捗 ${idx+1} / ${qTotal}</span>
      <span class="pill">性別: ${runtime.gender === "male" ? "男性" : "女性/その他"}</span>
    </div>

    <div class="progress" style="margin-top:10px;">
      <div class="bar" style="width:${pct}%"></div>
    </div>

    <div class="hr"></div>

    <div class="label">${escapeHTML(qid)}</div>
    <p class="qtitle">${escapeHTML(text)}</p>

    <div id="optArea">
      ${opts.map(o => `
        <button class="opt" data-opt="${escapeHTML(o.opt)}">
          ${escapeHTML(o.label)}
          ${answered === o.opt ? ' <span class="pill" style="float:right;">選択中</span>' : ''}
        </button>
      `).join("")}
    </div>

    <div class="row" style="margin-top:10px;">
      <button class="btn ghost" id="btnPrev" ${idx===0?'disabled':''}>戻る</button>
      <button class="btn danger" id="btnRestart">最初からやり直す</button>
    </div>

    <p class="tiny" style="margin-top:10px;">
      ※回答は進むたびに保存されます（ブラウザ更新でも戻れます）。<br/>
      ※ただし「結果表示まで到達したら」次回は自動で最初からになります。
    </p>

    <div id="msg"></div>
  `;

  // options click
  document.querySelectorAll("#optArea .opt").forEach(btn=>{
    btn.onclick = async () => {
      const opt = btn.getAttribute("data-opt");
      await answerQuestion(qid, opt);
    };
  });

  document.getElementById("btnPrev").onclick = () => {
    runtime.idx = Math.max(0, runtime.idx - 1);
    saveLS();
    render();
  };

  document.getElementById("btnRestart").onclick = () => {
    // 手動やり直し（結果到達前なら許可）
    if (!confirm("最初からやり直しますか？")) return;
    runtime.sid = newSessionId();
    runtime.gender = "";
    runtime.questions = [];
    runtime.idx = 0;
    runtime.answers = {};
    runtime.result = null;
    localStorage.removeItem(LS.gender);
    localStorage.removeItem(LS.sid);
    localStorage.removeItem(LS.answers);
    localStorage.removeItem(LS.progress);
    render();
  };
}

async function answerQuestion(qid, opt){
  // 保存（ローカル）
  runtime.answers[qid] = opt;
  saveLS();

  // 1問ごとGAS送信（失敗しても続行）
  const msg = document.getElementById("msg");
  msg.innerHTML = `<div class="tiny">保存中…</div>`;

  try{
    const payload = {
      action: ACTIONS.LOG,
      sessionId: runtime.sid,
      gender: runtime.gender,
      qid,
      opt,
      answeredAt: nowISO()
    };
    const r = await postGAS(payload);
    // LOGが未実装でも止めない
    msg.innerHTML = r?.ok
      ? `<div class="ok tiny">保存OK</div>`
      : `<div class="tiny">（保存はローカルのみで継続中）</div>`;
  }catch(_){
    msg.innerHTML = `<div class="tiny">（通信が不安定なので、ローカル保存のまま継続します）</div>`;
  }

  // 次へ
  runtime.idx += 1;
  saveLS();
  render();
}

function renderName(){
  $app.innerHTML = `
    <div class="label">おなまえ（任意）</div>
    <p class="qtitle">診断結果を、あなたのお名前に変えてお届けします！</p>
    <input id="nameInput" class="field" placeholder="例）とあ" maxlength="30" />
    <p class="tiny" style="margin-top:10px;">
      ※未入力の場合は「あなた」になります。<br/>
      ※それ以外の目的で名前を使用することはありません。
    </p>
    <div class="hr"></div>
    <button class="btn primary" id="btnFinalize">結果を見る</button>
    <div id="msg"></div>
    <div class="row" style="margin-top:10px;">
      <button class="btn ghost" id="btnBack">戻って回答を見直す</button>
    </div>
  `;

  document.getElementById("btnBack").onclick = () => {
    // 回答の最後へ戻す
    runtime.idx = Math.max(0, (runtime.questions?.length || 1) - 1);
    saveLS();
    setStep("quiz");
  };

  document.getElementById("btnFinalize").onclick = async () => {
    const raw = document.getElementById("nameInput").value.trim();
    runtime.name = raw ? raw : "あなた";

    const msg = document.getElementById("msg");
    msg.innerHTML = `<div class="tiny">集計中…</div>`;

    try{
      const r = await postGAS({
        action: ACTIONS.FINALIZE,
        sessionId: runtime.sid,
        gender: runtime.gender,
        name: runtime.name
      });

      if (!r?.ok) {
        msg.innerHTML = `<div class="err">集計に失敗: ${escapeHTML(r?.error || "unknown")}</div>`;
        return;
      }

      runtime.result = r;

      // ★ここが仕様の核：結果に到達したら次回は新規にする
      // sessionId自体は画面内送信用に runtime.sid に残す（localStorageだけ消す）
      clearLSAfterResult();

      setStep("result");
    }catch(err){
      msg.innerHTML = `<div class="err">集計に失敗: ${escapeHTML(err.message)}</div>`;
    }
  };
}

function renderResult(){
  const r = runtime.result;
  if (!r){
    $app.innerHTML = `<div class="err">結果データがありません。もう一度やり直してください。</div>
      <div class="hr"></div><button class="btn danger" id="btnRestart">最初から</button>`;
    document.getElementById("btnRestart").onclick = () => location.reload();
    return;
  }

  // 見出し
  const name = escapeHTML(r.name || runtime.name || "あなた");
  const prefix = escapeHTML(r.prefix || "");
  const animal = escapeHTML(r.animal || "");
  const topLabel = `${prefix}${animal}`;

  // 特徴（GASがテキスト返す想定）
  const animalFeature = escapeHTML(r.features?.animal || "").replace(/\n/g,"<br/>");
  const prefixFeature = escapeHTML(r.features?.prefix || "").replace(/\n/g,"<br/>");

  const axisTitle = {
    A:"①思考・意思決定の深層スタイル",
    B:"②感情との距離感・扱い方",
    C:"③自己価値感・自己肯定の源泉",
    D:"④ストレス構造と回復パターン",
    E:"⑤対人関係・距離感のクセ",
    F:"⑥親密さ・恋愛における心理傾向",
    G:"⑦性と自己理解のつながり方",
    H:"⑧人生の進み方・停滞ポイント"
  };

  const sectionsHTML = ["A","B","C","D","E","F","G","H"].map(k=>{
    const txt = escapeHTML(r.sections?.[k] || "").replace(/\n/g,"<br/>");
    return `
      <div class="hr"></div>
      <div class="sectionTitle">${axisTitle[k]}</div>
      <div class="pre">${txt || "（準備中）"}</div>
    `;
  }).join("");

  $app.innerHTML = `
    <div class="label">診断結果</div>
    <p class="qtitle">${name}さんは… <span class="pill">${topLabel || "（集計中）"}</span> です！</p>

    <div class="tiny">（イラストは後で差し込み予定）</div>

    <div class="hr"></div>
    <div class="sectionTitle">${prefix}${animal} の ${name}さんは</div>

    <div class="tiny" style="margin-top:8px;">・動物グループの特徴</div>
    <div class="mutedBox pre">${animalFeature || "（準備中）"}</div>

    <div class="tiny" style="margin-top:10px;">・接頭語グループの特徴</div>
    <div class="mutedBox pre">${prefixFeature || "（準備中）"}</div>

    ${sectionsHTML}

    <div class="hr"></div>
    <div class="sectionTitle">結果をメールで受け取る（任意）</div>
    <input id="emailInput" class="field" placeholder="example@gmail.com" />
    <p class="tiny" style="margin-top:10px;">
      ※結果のメール送信以外の目的で、メールアドレスを使用することはありません。
    </p>
    <div class="row">
      <button class="btn primary" id="btnSendEmail">この結果をメールで送る</button>
      <button class="btn ghost" id="btnNew">新しく診断する</button>
    </div>
    <div id="emailMsg"></div>
    <p class="tiny" style="margin-top:10px;">
      ※このページを閉じても、次回アクセス時は自動で最初からになります（結果到達時に端末保存を消しています）。
    </p>
  `;

  document.getElementById("btnNew").onclick = () => {
    // 次回は必ず新規のはずだが、ここでリロードして即新規開始できるように
    location.reload();
  };

  document.getElementById("btnSendEmail").onclick = async () => {
    const email = document.getElementById("emailInput").value.trim();
    const emailMsg = document.getElementById("emailMsg");
    if (!email){
      emailMsg.innerHTML = `<div class="err">メールアドレスを入力してください。</div>`;
      return;
    }
    emailMsg.innerHTML = `<div class="tiny">送信中…</div>`;

    try{
      const rr = await postGAS({
        action: ACTIONS.EMAIL,
        sessionId: runtime.sid, // localStorageは消しても、メモリ上には残ってる
        email
      });

      if (!rr?.ok){
        emailMsg.innerHTML = `<div class="err">送信に失敗: ${escapeHTML(rr?.error || "unknown")}</div>`;
        return;
      }

      if (rr.skipped){
        emailMsg.innerHTML = `<div class="ok">すでに送信済みです（重複送信を防止しました）。</div>`;
      }else{
        emailMsg.innerHTML = `<div class="ok">送信しました！受信箱をご確認ください。</div>`;
      }
    }catch(err){
      emailMsg.innerHTML = `<div class="err">送信に失敗: ${escapeHTML(err.message)}</div>`;
    }
  };
}
</script>
</body>
</html>
