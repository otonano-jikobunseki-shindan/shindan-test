<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="robots" content="noindex,nofollow" />
  <title>è¨ºæ–­çµæœ</title>

  <style>
    :root{
      --bg1:#fff7ef;
      --bg2:#fff1f6;
      --card:#ffffffcc;
      --text:#2b2b2b;
      --muted:#6b7280;
      --line:#f1d7c8;
      --shadow: 0 10px 30px rgba(20,10,5,.08);
      --shadow2: 0 6px 18px rgba(20,10,5,.06);
      --radius: 18px;
      --radius2: 14px;
      --accent:#ff7a59;
      --good1:#34d399;
      --good2:#22c55e;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-rounded, system-ui, -apple-system, "Segoe UI", Roboto,
        "Hiragino Maru Gothic ProN","Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic",sans-serif;
      background: radial-gradient(1200px 700px at 20% 10%, var(--bg2), transparent 60%),
                  radial-gradient(1200px 700px at 80% 0%, #fffbe6, transparent 55%),
                  linear-gradient(180deg, var(--bg1), #ffffff);
      color:var(--text);
    }
    .wrap{max-width:760px;margin:0 auto;padding:18px 14px 40px;}
.hero{
  padding:18px 16px;border:1px solid var(--line);border-radius:var(--radius);
  background:rgba(255,255,255,.78);box-shadow: var(--shadow);backdrop-filter: blur(10px);
  text-align:center;
}
    h1{font-size:22px;margin:0 0 8px;letter-spacing:.2px;}
    .sub{color:var(--muted);line-height:1.7;margin:0;}
    .card{
      margin-top:14px;padding:16px;border:1px solid var(--line);border-radius:var(--radius);
      background:rgba(255,255,255,.72);box-shadow: var(--shadow2);
    }
    .hr{height:1px;background: linear-gradient(90deg, transparent, var(--line), transparent);margin:14px 0;}
    .tiny{font-size:12px;color:var(--muted);line-height:1.7;margin-top:8px;}

    .ok{
      color:#064e3b;background: rgba(34,197,94,.10);
      border:1px solid rgba(34,197,94,.25);
      padding:10px;border-radius:var(--radius2);margin-top:10px;line-height:1.7;
    }
    .err{
      color:#7f1d1d;background: rgba(239,68,68,.08);
      border:1px solid rgba(239,68,68,.25);
      padding:10px;border-radius:var(--radius2);margin-top:10px;line-height:1.7;
    }

    /* â˜…ã“ã“ã ã‘ãŒï¼ˆå°†æ¥ã‚¹ã‚¯ã‚·ãƒ§å¯¾è±¡ã«ã—ãŸã„ãªã‚‰ï¼‰åˆ‡ã‚Šå‡ºã—ã‚„ã™ã„ */
    #shareTop{
      border:1px solid #f3d2c2;
      border-radius:var(--radius);
      padding:14px;
      background: rgba(255,255,255,.86);
      box-shadow: 0 6px 18px rgba(20,10,5,.05);
    }
    .who{
      font-size:18px;
      font-weight:1000;
      margin:0 0 10px;
      line-height:1.4;
    }
    .badgeRow{
      display:flex;
      flex-direction:column;
      gap:12px;
      align-items:center;
    }

    /* â˜…è¿½åŠ ï¼šã‚¤ãƒ©ã‚¹ãƒˆæ ãã®ã‚‚ã®ï¼ˆä»Šã¾ã§ç„¡ã‹ã£ãŸã®ã§è¿½è¨˜ãŒå¿…è¦ï¼‰ */
    .illus{
      width:100%;
      height:auto;
      aspect-ratio: 1 / 1;   /* æ¨ªé•·ã€‚æ­£æ–¹å½¢ãŒè‰¯ã‘ã‚Œã° 1 / 1 */
      border:none;            /* ç‚¹ç·šæ ã„ã‚‰ãªã„ */
      border-radius:18px;
      background: rgba(255,255,255,.6);
      overflow:hidden;
      display:block;
    }

    /* â˜…è¿½åŠ ï¼šã‚¤ãƒ©ã‚¹ãƒˆç”»åƒè¡¨ç¤ºç”¨ï¼ˆæ å†…ã«ã´ã£ãŸã‚Šåã‚ã‚‹ï¼‰ */
    .illus img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
  

    .typeBox{flex:1 1 auto;min-width:200px;}
    .typeMain{font-size:22px;font-weight:1100;margin:0 0 6px;letter-spacing:.2px;}
    .typeSub{margin:0;color:var(--muted);line-height:1.6;white-space:pre-wrap;}

    .sectionTitle{
  font-weight:1000;
  margin:14px 0 10px;
  font-size:22px;

  background: linear-gradient(90deg,#fff1f6,#fff7ef);
  padding:8px 12px;
  border-left:5px solid var(--accent);
  border-radius:8px;
}

    .text{
      white-space:pre-wrap;
      line-height:1.85;
      margin:0;
    }

    .field{
      width:100%;
      padding:12px;
      border-radius:var(--radius2);
      border:1px solid #f3d2c2;
      background:#fff;
      color:var(--text);
      font-size:16px;
    }

    .btn{
      appearance:none;
      border:1px solid #f3d2c2;
      background:#fff;
      color:var(--text);
      padding:12px 14px;
      border-radius:var(--radius2);
      font-weight:900;
      cursor:pointer;
      width:100%;
      box-shadow: 0 4px 12px rgba(20,10,5,.06);
      transition: transform .06s ease, box-shadow .2s ease, border-color .2s ease;
    }
    .btn:active{transform: translateY(1px);}
    .btn.good{
      background: linear-gradient(90deg, var(--good1), var(--good2));
      border-color: transparent;
      color:#0b2b1f;
    }
    .btn:disabled{opacity:.55;cursor:not-allowed}

    .loadingRow{
      display:flex;gap:10px;align-items:center;
      color:var(--muted);
      font-weight:900;
    }
    .spinner{
      width:18px;height:18px;border-radius:999px;
      border:3px solid rgba(0,0,0,.08);
      border-top-color: rgba(0,0,0,.35);
      animation: spin 0.9s linear infinite;
    }
    @keyframes spin{to{transform: rotate(360deg)}}

    /* è¿½åŠ ï¼šã‚¹ã‚¯ã‚·ãƒ§ï¼ˆç”»åƒä¿å­˜ï¼‰ãƒœã‚¿ãƒ³å‘¨ã‚Š */
        /* ===== è¿½åŠ ï¼šãƒ¢ã‚¶ã‚¤ã‚¯ï¼ˆãƒˆãƒƒãƒ—æ–‡ç« ã‚ˆã‚Šä¸‹ã‚’ã¼ã‹ã™ï¼‰ ===== */
    #mosaicArea{
      position: relative;
    }
    #mosaicArea.isMosaic{
      filter: blur(10px);
      opacity: .9;
      pointer-events: none; /* ã¼ã‹ã—ä¸­ã¯æ“ä½œã§ããªã„ï¼ˆè§£é™¤å¾Œã«æ“ä½œOKï¼‰ */
      user-select: none;
    }

    .shotBox{margin-top:10px;}
    /* ===== DMé·ç§»å‰ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— ===== */
.dmPopupOverlay{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.35);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  padding: 18px;
}
.dmPopupOverlay.isOpen{ display:flex; }

.dmPopupCard{
  width: min(420px, 92vw);
  background: #ffffff;
  border-radius: 18px;
  box-shadow: 0 18px 45px rgba(0,0,0,.18);
  padding: 16px 16px 14px;
  color: #2b2b2b;
}
.dmPopupTitle{
  font-weight: 700;
  font-size: 15px;
  margin: 0 0 8px;
}
.dmPopupText{
  font-size: 14px;
  line-height: 1.6;
  margin: 0 0 12px;
  white-space: pre-line; /* æ”¹è¡Œã‚’åŠ¹ã‹ã›ã‚‹ */
}
.dmPopupActions{
  display: flex;
  gap: 10px;
  justify-content: flex-end;
}
.dmPopupBtn{
  border: none;
  border-radius: 12px;
  padding: 10px 12px;
  font-size: 14px;
  cursor: pointer;
}
.dmPopupBtn.primary{
  background: #ff7a59;
  color: #fff;
}
.dmPopupBtn.ghost{
  background: #f3f4f6;
  color: #374151;
}

  </style>
</head>

<body>
  <div class="wrap">
    <div class="hero">
      <h1>è¨ºæ–­çµæœ</h1>
    </div>

    <div class="card" id="statusCard">
      <div class="loadingRow" id="loadingRow">
        <div class="spinner"></div>
        <div>èª­ã¿è¾¼ã¿ä¸­â€¦</div>
      </div>
      <div id="msg"></div>
      <div style="margin-top:12px;display:none;" id="retryBox">
        <button class="btn" onclick="loadResult()">ã‚‚ã†ä¸€åº¦èª­ã¿è¾¼ã‚€</button>
        <div class="tiny">â€»é›†è¨ˆãŒã¾ã ã®å ´åˆã€å°‘ã—å¾…ã£ã¦ã‹ã‚‰å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚</div>
      </div>
    </div>

    <div class="card" id="resultCard" style="display:none;">
      <!-- â˜…ä¸Šéƒ¨ï¼ˆã‚ãªãŸã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼‰ -->
      <div id="shareTop">
        <p class="who"><span id="nameSpan">ã‚ãªãŸ</span>ã•ã‚“ã¯ã€</p>
        <div class="badgeRow">
          <div class="illus" id="illusBox">ILLUST</div>
          <div class="typeBox">
            <p class="typeMain">
              <span id="prefixSpan">æ¥é ­èª</span><span id="animalSpan">å‹•ç‰©</span>
              ã§ã™ï¼
            </p>
          </div>
        </div>
      </div>

      <!-- è¿½åŠ ï¼šãƒœã‚¿ãƒ³ï¼ˆä¸Šå´ï¼‰ -->
      <div class="shotBox">
        <button class="btn" id="shotBtnTop" onclick="saveShareTopImage('top')">çµæœã®éƒ¨åˆ†ã ã‘ã‚’ä¿å­˜ã™ã‚‹</button>
        <div class="tiny">â€»ã“ã®éƒ¨åˆ†ã‹ã‚‰ã€æ€§ã«é–¢ã™ã‚‹å›ç­”å†…å®¹ãŒæ¼ã‚Œã‚‹å¿ƒé…ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>
        <div id="shotMsgTop"></div>
      </div>

      <div class="hr"></div>

      <p class="text" id="topText"></p>


<!-- ===== åˆè¨€è‘‰UIï¼ˆãƒ¢ã‚¶ã‚¤ã‚¯ã®å¤–ï¼šæŠ¼ã›ã‚‹çŠ¶æ…‹ï¼‰ ===== -->
<div id="unlockBox" style="display:none;padding:12px;margin-bottom:12px;border:1px dashed #f3d2c2;border-radius:14px;background:rgba(255,255,255,.85);">

  <p class="sectionTitle">ã“ã“ã‹ã‚‰å…ˆã¯ã€ã‚ãªãŸã®å›ç­”ã‚’åˆ†æã—ãŸè©³ç´°ãªè¨ºæ–­ã§ã™ï¼</p>
<div class="tiny">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ä¿è­·ã®ãŸã‚ã€åˆè¨€è‘‰å…¥åŠ›ã‚’ãŠã­ãŒã„ã—ã¾ã™ã€‚</div>

  <p class="sectionTitle">åˆè¨€è‘‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
  <input class="field" id="unlockInput" placeholder="åˆè¨€è‘‰ã‚’å…¥åŠ›">
  <button class="btn" style="margin-top:8px;" onclick="tryUnlock()">åˆè¨€è‘‰ã§è§£é™¤</button>
  <div class="tiny">â†“åˆè¨€è‘‰ç™ºè¡ŒãŒã¾ã ã®æ–¹ã¯ä»¥ä¸‹ã‹ã‚‰ï¼â†“</div>
  <div id="unlockMsg"></div>
  <button class="btn" id="genKeyBtn" style="margin-top:10px;" onclick="generateKey()">
  åˆè¨€è‘‰ã‚’ç™ºè¡Œã™ã‚‹<br>ï¼ˆä»Šã ã‘ç„¡æ–™ï¼ç™»éŒ²ä¸è¦ï¼ï¼‰
</button>

</div>

        <div class="tiny" style="text-align:center;margin:6px 0 10px;">
  ã“ã“ã‹ã‚‰å…ˆã¯ã€ã€Œè‡ªå·±ç†è§£ã®æ•™ç§‘æ›¸ã€ã¿ãŸã„ãªã‚‚ã®ã§ã™â€¦ğŸ“š<br>ç´å¾—ã™ã‚‹äººç¶šå‡ºï¼ãœã²ã”è¦§ãã ã•ã„âœ¨
</div>
<!-- ===== ã“ã“ã‹ã‚‰ä¸‹ã ã‘ãƒ¢ã‚¶ã‚¤ã‚¯ï¼ˆæŠ¼ã›ãªã„ã®ã¯ã“ã“ã§OKï¼‰ ===== -->
<div id="mosaicArea">


  <div class="hr"></div>

  <div id="sections"></div>

  <div class="hr"></div>

  <!-- ãƒ¡ãƒ¼ãƒ«é€ä¿¡ãƒ–ãƒ­ãƒƒã‚¯ -->
  <div>

    <div class="shotBox" style="margin-top:10px;">
      <button class="btn" id="inviteBtn" onclick="issueInviteUrl()">æ‹›å¾…URLã‚’ç™ºè¡Œ</button>
      <div id="inviteMsg"></div>
    </div>

    <div class="shotBox" style="margin-top:10px;">
      <button class="btn" id="shotBtnBottom" onclick="saveShareTopImage('bottom')">çµæœã®éƒ¨åˆ†ã ã‘ã‚’ä¿å­˜ã™ã‚‹</button>
      <div class="tiny">â€»ã“ã®éƒ¨åˆ†ã‹ã‚‰ã€æ€§ã«é–¢ã™ã‚‹å›ç­”å†…å®¹ãŒæ¼ã‚Œã‚‹å¿ƒé…ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>
      <div id="shotMsgBottom"></div>
    </div>
    
        <p class="sectionTitle">ã“ã®çµæœå…¨æ–‡ã‚’ã€ãƒ¡ãƒ¼ãƒ«ã«é€ä¿¡ã—ã¾ã™ï¼</p>

    <input class="field" id="emailInput" type="email" inputmode="email" autocomplete="email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›">
    <div class="tiny">â€»ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯ã€çµæœã®ãƒ¡ãƒ¼ãƒ«é€ä¿¡ä»¥å¤–ã«ã¯ä½¿ç”¨ã—ã¾ã›ã‚“ã€‚</div>

    <button class="btn good" id="sendBtn" onclick="sendEmail()" style="margin-top:10px;">ã“ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã«é€ä¿¡ã™ã‚‹</button>
    <div id="emailMsg"></div>
  </div>
</div>


    </div>
  </div>

<script>
  const GAS_URL = "https://script.google.com/macros/s/AKfycbz0nSbcIZKV6P3d8NPu1mZKRjVLT2EF6grR5nfc2otxiky6jdaRBiFhskvjoemWUlOn/exec";

  const params = new URLSearchParams(location.search);
  const sessionId = params.get("sid");

  const AXIS_TITLES = {
    A: "â‘ æ€è€ƒãƒ»æ„æ€æ±ºå®šã®æ·±å±¤ã‚¹ã‚¿ã‚¤ãƒ«",
    B: "â‘¡æ„Ÿæƒ…ã¨ã®è·é›¢æ„Ÿãƒ»æ‰±ã„æ–¹",
    C: "â‘¢è‡ªå·±ä¾¡å€¤æ„Ÿãƒ»è‡ªå·±è‚¯å®šã®æºæ³‰",
    D: "â‘£ã‚¹ãƒˆãƒ¬ã‚¹æ§‹é€ ã¨å›å¾©ãƒ‘ã‚¿ãƒ¼ãƒ³",
    E: "â‘¤å¯¾äººé–¢ä¿‚ãƒ»è·é›¢æ„Ÿã®ã‚¯ã‚»",
    F: "â‘¥è¦ªå¯†ã•ãƒ»æ‹æ„›ã«ãŠã‘ã‚‹å¿ƒç†å‚¾å‘",
    G: "â‘¦æ€§ã¨è‡ªå·±ç†è§£ã®ã¤ãªãŒã‚Šæ–¹",
    H: "â‘§äººç”Ÿã®é€²ã¿æ–¹ãƒ»åœæ»ãƒã‚¤ãƒ³ãƒˆ",
  };

  function escapeHtml(s){
    return String(s||"").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }
  function setMsg(kind, text){
    const el = document.getElementById("msg");
    if (!text){ el.innerHTML = ""; return; }
    el.innerHTML = `<div class="${kind === 'err' ? 'err' : 'ok'}">${escapeHtml(text)}</div>`;
  }
  function setEmailMsg(kind, text){
    const el = document.getElementById("emailMsg");
    if (!text){ el.innerHTML = ""; return; }
    el.innerHTML = `<div class="${kind === 'err' ? 'err' : 'ok'}">${escapeHtml(text)}</div>`;
  }

  /* è¿½åŠ ï¼šã‚¹ã‚¯ã‚·ãƒ§ä¿å­˜ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
  function setShotMsg(pos, kind, text){
    const el = document.getElementById(pos === "bottom" ? "shotMsgBottom" : "shotMsgTop");
    if (!text){ el.innerHTML = ""; return; }
    el.innerHTML = `<div class="${kind === 'err' ? 'err' : 'ok'}">${escapeHtml(text)}</div>`;
  }
  /* è¿½åŠ ï¼šæ‹›å¾…URLãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
function setInviteMsg(kind, text){
  const el = document.getElementById("inviteMsg");
  if (!el) return;
  if (!text){ el.innerHTML = ""; return; }
  el.innerHTML = `<div class="${kind === 'err' ? 'err' : 'ok'}">${escapeHtml(text)}</div>`;
}

/* è¿½åŠ ï¼šãƒ©ãƒ³ãƒ€ãƒ æ‹›å¾…ã‚³ãƒ¼ãƒ‰ç”Ÿæˆï¼ˆçŸ­ã‚ã§ååˆ†æ¨æ¸¬ã•ã‚Œã«ãã„ï¼‰ */
function makeInviteCode(){
  // cryptoãŒä½¿ãˆã‚‹ç’°å¢ƒãªã‚‰å¼·ã‚ã€ãƒ€ãƒ¡ãªã‚‰Math.randomã§ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
  if (window.crypto && crypto.getRandomValues){
    const bytes = new Uint8Array(12);
    crypto.getRandomValues(bytes);
    // URLã«è¼‰ã›ã‚„ã™ã„base36ã£ã½ã„æ–‡å­—åˆ—ã¸
    return Array.from(bytes, b => (b % 36).toString(36)).join("");
  }
  return (Math.random().toString(36).slice(2) + Math.random().toString(36).slice(2)).slice(0, 18);
}

/* è¿½åŠ ï¼šæ‹›å¾…URLç™ºè¡Œï¼ˆ1ã‚»ãƒƒã‚·ãƒ§ãƒ³1å›ã£ã½ãè¦‹ã›ã‚‹ï¼‰ */
async function issueInviteUrl(){
  setInviteMsg("", "");

  if (!sessionId){
    setInviteMsg("err", "ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±(sid)ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
    return;
  }

  const btn = document.getElementById("inviteBtn");
  if (!btn) return;

  // ç™ºè¡Œæ¸ˆã¿ãƒã‚§ãƒƒã‚¯ï¼ˆå³å¯†ä¿è¨¼ã§ã¯ãªãâ€œè¦‹ã›æ–¹â€ï¼‰
  const issuedKey = "inviteIssued_" + String(sessionId || "");
  const already = localStorage.getItem(issuedKey);
  if (already){
    btn.disabled = true;
    btn.textContent = "ç™ºè¡Œæ¸ˆã¿";
    setInviteMsg("ok", "ã“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§ã¯æ‹›å¾…URLã¯ç™ºè¡Œæ¸ˆã¿ã§ã™ã€‚");
    return;
  }

  // æ°åå…¥åŠ›ï¼ˆã‚­ãƒ£ãƒ³ã‚»ãƒ«ãªã‚‰ä¸­æ–­ï¼‰
  const inviterName = "æ‹›å¾…URLç™ºè¡Œï¼";


  btn.disabled = true;
  btn.textContent = "ç™ºè¡Œä¸­â€¦";

  try{
    // æ‹›å¾…ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ & URLçµ„ã¿ç«‹ã¦ï¼ˆåŒéšå±¤ã®index.htmlã¸ï¼‰
    const inviteCode = makeInviteCode();
    const inviteUrl = new URL("index.html", location.href);
    inviteUrl.searchParams.set("invite", inviteCode);
    inviteUrl.searchParams.set("from", String(sessionId).replace(/[^a-zA-Z0-9]/g,"").slice(-8));

    // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã¸ã‚³ãƒ”ãƒ¼
    // â€»Safariãªã©ã§å¤±æ•—ã™ã‚‹å ´åˆã«å‚™ãˆã¦ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚‚ç”¨æ„
    try{
      await navigator.clipboard.writeText(inviteUrl.toString());
    }catch(_){
      const ta = document.createElement("textarea");
      ta.value = inviteUrl.toString();
      ta.style.position = "fixed";
      ta.style.left = "-9999px";
      document.body.appendChild(ta);
      ta.focus();
      ta.select();
      const ok = document.execCommand("copy");
      ta.remove();
      if (!ok) throw new Error("clipboard copy failed");
    }

    await postToGAS({
  action: "logInviteIssue",
  sessionId,
  inviterName,
  inviteCode,
  inviteUrl: inviteUrl.toString()
});

    // ç™ºè¡Œæ¸ˆã¿ã¨ã—ã¦ä¿å­˜ï¼ˆâ€œè¦‹ã›æ–¹â€ï¼‰
    localStorage.setItem(issuedKey, "1");


    btn.textContent = "ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ";
    btn.disabled = true;
    setInviteMsg("ok", "æ‹›å¾…URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚è²¼ã‚Šä»˜ã‘ã¦å…±æœ‰ã§ãã¾ã™ã€‚");

  }catch(e){
    console.warn(e);
    btn.disabled = false;
    btn.textContent = "æ‹›å¾…URLã‚’ç™ºè¡Œ";
    setInviteMsg("err", "ç™ºè¡Œã«å¤±æ•—ã—ã¾ã—ãŸï¼š" + (e && e.message ? e.message : "unknown error"));
  }
}


async function postToGAS(payloadObj){
  const maxTry = 5;
  for (let t=1; t<=maxTry; t++){
    try{
      const body = new URLSearchParams();
      body.set("payload", JSON.stringify(payloadObj));

      const res = await fetch(GAS_URL, {
        method: "POST",
        headers: {"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},
        body: body.toString(),
      });

      const text = await res.text();
      let json = {};
      try{ json = JSON.parse(text); }catch(_){}

      if (json && json.ok === false && json.error === "busy"){
        const wait = Number(json.retryAfterMs || 800);
        await new Promise(r => setTimeout(r, wait + Math.floor(Math.random()*200)));
        continue;
      }
      return json;

    }catch(err){
      if (t === maxTry) throw err;
      const backoff = Math.min(2000, 300 * (2 ** (t-1)));
      await new Promise(r => setTimeout(r, backoff + Math.floor(Math.random()*200)));
    }
  }
}


  function showLoading(on){
    document.getElementById("loadingRow").style.display = on ? "flex" : "none";
  }

  function showRetry(on){
    document.getElementById("retryBox").style.display = on ? "block" : "none";
  }
    // è¿½åŠ ï¼šãƒ¢ã‚¶ã‚¤ã‚¯ON/OFFï¼ˆNo.4ã¯ONã«ã™ã‚‹ã ã‘ï¼‰
  function setMosaic(on){
    const area = document.getElementById("mosaicArea");
    if (!area) return;
    if (on) area.classList.add("isMosaic");
    else area.classList.remove("isMosaic");
  }
    // No.5 ãƒ€ãƒŸãƒ¼è§£é™¤ï¼ˆã¾ã åˆ¤å®šã—ãªã„ï¼‰
  function normalizeKey(s){
  return String(s || "")
    .toLowerCase()
    .replace(/\s+/g, ""); // ç©ºç™½ãƒ»æ”¹è¡Œã™ã¹ã¦é™¤å»
}

const VALID_KEYS = [
  "j9aovb64",
  "dioap90h6",
  "ko99j7ftny"
];
  let issueKeyInFlight = false;

  function openInstagramDM(igHandle, dmText){
  // ã„ã¡ã°ã‚“ã€Œå®›å…ˆé¸æŠã€ã‚’é¿ã‘ã‚„ã™ã„ï¼šig.me
  const igMeUrl =
    `https://ig.me/m/${encodeURIComponent(igHandle)}?text=${encodeURIComponent(dmText)}`;

  // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã«é£›ã°ã™ï¼ˆDMã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã«ãªã‚‹ãŒã€å®›å…ˆã‚ºãƒ¬ã¯èµ·ããªã„ï¼‰
  const webProfileUrl =
    `https://www.instagram.com/${encodeURIComponent(igHandle)}/`;

  try{
    // ã¾ãš ig.me ã‚’é–‹ã
    window.location.href = igMeUrl;

    // ã‚‚ã—é·ç§»ã§ããªã„ç’°å¢ƒã®ä¿é™ºï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã«ã‚ˆã£ã¦ã¯ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã‚‹ï¼‰
    setTimeout(()=>{ window.location.href = webProfileUrl; }, 900);
  }catch(_){
    window.location.href = webProfileUrl;
  }
}


async function copyToClipboard(text){
  try{
    await navigator.clipboard.writeText(text);
    return true;
  }catch(_){
    const ta = document.createElement("textarea");
    ta.value = text;
    ta.style.position = "fixed";
    ta.style.left = "-9999px";
    document.body.appendChild(ta);
    ta.focus();
    ta.select();
    const ok = document.execCommand("copy");
    ta.remove();
    return ok;
  }
}

  /* ===== DMé·ç§»å‰ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— ===== */
function showDmPopup(message, onGo){
  const overlay = document.getElementById("dmPopup");
  const textEl = document.getElementById("dmPopupText");
  const btnGo = document.getElementById("dmPopupGo");
  const btnCancel = document.getElementById("dmPopupCancel");
  if (!overlay || !textEl || !btnGo){
    // ã‚‚ã—DOMãŒç„¡ã„å ´åˆã¯ãã®ã¾ã¾é·ç§»ï¼ˆä¿é™ºï¼‰
    try{ onGo && onGo(); }catch(_){}
    return;
  }

  textEl.textContent = message;

  const close = () => {
    overlay.classList.remove("isOpen");
    overlay.setAttribute("aria-hidden","true");
    btnGo.onclick = null;
    if (btnCancel) btnCancel.onclick = null;
    // èƒŒæ™¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æˆ»ã™
    document.documentElement.style.overflow = "";
    document.body.style.overflow = "";
  };

  if (btnCancel) btnCancel.onclick = () => close();
  btnGo.onclick = () => {
    close();
    try{ onGo && onGo(); }catch(_){}
  };

  // èƒŒæ™¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ­¢ã‚ã‚‹ï¼ˆå¨åœ§æ„Ÿã¯å‡ºã•ãšã€èª¤ã‚¿ãƒƒãƒ—é˜²æ­¢ï¼‰
  document.documentElement.style.overflow = "hidden";
  document.body.style.overflow = "hidden";

  overlay.classList.add("isOpen");
  overlay.setAttribute("aria-hidden","false");
}

  
  /* ===== REPLACE START: generateKey() ===== */
async function generateKey(){
  const msg = document.getElementById("unlockMsg");
  const btn = document.getElementById("genKeyBtn");

  // é€£æ‰“ã‚¬ãƒ¼ãƒ‰
  if (issueKeyInFlight) return;
  issueKeyInFlight = true;

  if (btn){
    btn.disabled = true;
    btn.textContent = "ç™ºè¡Œä¸­â€¦";
  }
  if (msg) msg.innerHTML = "ç§˜å¯†ã®éµã‚’ç™ºè¡Œä¸­â€¦";

  try{
    if (!sessionId) throw new Error("sessionId ãŒã‚ã‚Šã¾ã›ã‚“");

    const igHandle = "reply.only.aikotoba";
    const storedKeyK = "issued_key_" + String(sessionId || "");
    const storedTimeK = "issued_keyTime_" + String(sessionId || "");

    // ç«¯æœ«å†…ã«æ—¢ç™ºè¡ŒãŒã‚ã‚Œã°ãã‚Œã‚’å†åˆ©ç”¨ï¼ˆé€£æ‰“ãƒ»å†èª­ã¿è¾¼ã¿è€æ€§ï¼‰
    let key = "";
    let keyTime = "";
    try{
      key = (localStorage.getItem(storedKeyK) || "").trim();
      keyTime = (localStorage.getItem(storedTimeK) || "").trim();
    }catch(e){}

    // ç„¡ã‘ã‚Œã°GASã«ç™ºè¡Œä¾é ¼
    if (!key){
      const r = await postToGAS({ action: "issueKey", sessionId });
      if (!r || !r.ok){
        throw new Error((r && (r.error || r.message)) ? (r.error || r.message) : "issueKey failed");
      }
      key = String(r.key || "").trim();
      keyTime = String(r.keyTime || "").trim();

      try{
        localStorage.setItem(storedKeyK, key);
        if (keyTime) localStorage.setItem(storedTimeK, keyTime);
      }catch(e){}
    }

    const dmText = `${key} ã“ã®æ–‡ç« ã‚’ãã®ã¾ã¾é€ã£ã¦ãã ã•ã„âœ¨`;

    // ã‚³ãƒ”ãƒ¼ï¼ˆå¤±æ•—ã—ã¦ã‚‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚ã‚Šï¼‰
    await copyToClipboard(dmText);

    // DMç”»é¢ã‚’é–‹ãï¼ˆæœ¬æ–‡å…¥ã‚Šã‚’è©¦ã™â†’ãƒ€ãƒ¡ãªã‚‰é€šå¸¸DMï¼‰
    showDmPopup(
  "ãã®ã¾ã¾è²¼ã‚Šä»˜ã‘ã—ã¦é€ä¿¡ã—ã¦ãã ã•ã„âœ¨\n\nâ€»ã“ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯åˆè¨€è‘‰ç™ºè¡Œ\nå°‚ç”¨ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ã™ã€‚\nå®Œå…¨è‡ªå‹•ã§é‹ç”¨ã—ã¦ã„ã¾ã™ã®ã§ã€\nã‚ãªãŸã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±ãŒæ¼ã‚Œã‚‹ã“ã¨ã¯\nã‚ã‚Šã¾ã›ã‚“ã€‚\n\nã”å®‰å¿ƒãã ã•ã„ğŸ˜Œ",
  () => openInstagramDM(igHandle, dmText)
);


    // è¡¨ç¤ºï¼ˆKeyã¯DMé€ä¿¡ç”¨ã€‚è§£é™¤ç”¨ã§ã¯ãªã„ï¼‰
if (msg){
  msg.innerHTML =
    `DMã«é€ã‚‹æ–‡ç« ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚Instagramã«è²¼ã‚Šä»˜ã‘ã¦é€ä¿¡ã—ã¦ãã ã•ã„ã€‚`;
}

    // â˜…è§£é™¤ç”¨å…¥åŠ›æ¬„ã¯ç©ºã«ã™ã‚‹ï¼ˆã“ã“ã«å…¥ã‚Œã‚‹ã®ã¯ã‚¤ãƒ³ã‚¹ã‚¿ã®è‡ªå‹•è¿”ä¿¡ã‚­ãƒ¼ï¼‰
const input = document.getElementById("unlockInput");
if (input) input.value = "";

  }catch(e){
    console.error(e);
    if (msg) msg.innerHTML = "åˆè¨€è‘‰ã®ç™ºè¡Œã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚";

  }finally{
    issueKeyInFlight = false;
    if (btn){
      btn.disabled = false;
      btn.textContent = "åˆã‚ã¦ã®è¡¨ç¤ºã¯ã“ã¡ã‚‰ï¼ˆåˆè¨€è‘‰ã‚’ç™ºè¡Œï¼‰";
    }
  }
}

/* ===== REPLACE END: generateKey() ===== */

// HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ï¼ˆXSSå¯¾ç­–ã®æœ€ä½é™ï¼‰
function escapeHtml_(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#39;");
}
/* ===== /REPLACE END: generateKey() ===== */

function tryUnlock(){

  
  // â˜…ã“ã“ã«å…¥ã‚Œã‚‹ï¼ˆä¸€ç•ªä¸Šï¼‰
  if (!sessionId){
    document.getElementById("unlockMsg").innerHTML =
      '<div class="err">ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±(sid)ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚</div>';
    return;
  }
  
  const raw = document.getElementById("unlockInput").value || "";
  const key = normalizeKey(raw);

  const ok = VALID_KEYS.includes(key);

  if (!ok){
    document.getElementById("unlockMsg").innerHTML =
      '<div class="err">åˆè¨€è‘‰ãŒé•ã„ã¾ã™ã€‚</div>';
    return;
  }

  // æˆåŠŸï¼šãƒ¢ã‚¶ã‚¤ã‚¯è§£é™¤
  // â˜…No.22 ä¿é™ºï¼šCSSã‚¯ãƒ©ã‚¹ã ã‘ã˜ã‚ƒãªãstyleã§ã‚‚å¼·åˆ¶è§£é™¤
const area = document.getElementById("mosaicArea");
if (area){
  area.classList.remove("isMosaic");
  area.style.filter = "none";
  area.style.opacity = "1";
  area.style.pointerEvents = "auto";
}

  setMosaic(false);

  // æ°¸ç¶šä¿å­˜ï¼ˆã“ã®ç«¯æœ«ã ã‘ï¼‰
  try{
    localStorage.setItem("unlocked_result_" + String(sessionId || ""), "1");
  }catch(e){}

// UIéè¡¨ç¤ºï¼ˆæˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¸è¦ï¼‰
const box = document.getElementById("unlockBox");
if (box) box.style.display = "none";
}




  function renderSections(result){
    const container = document.getElementById("sections");
    container.innerHTML = "";

    const items = [
      ["A", result.AText],
      ["B", result.BText],
      ["C", result.CText],
      ["D", result.DText],
      ["E", result.EText],
      ["F", result.FText],
      ["G", result.GText],
      ["H", result.HText],
    ];

    for (const [axis, text] of items){
      const card = document.createElement("div");
      card.style.marginTop = "12px";

      const title = document.createElement("p");
      title.className = "sectionTitle";
      title.textContent = AXIS_TITLES[axis] || axis;

      const p = document.createElement("p");
      p.className = "text";
      p.textContent = text || "";

      card.appendChild(title);
      card.appendChild(p);
      container.appendChild(card);
    }
  }

  /* è¿½åŠ ï¼šè§’ä¸¸çŸ©å½¢ï¼ˆCanvasï¼‰ */
  function roundRectPath(ctx, x, y, w, h, r){
    const rr = Math.max(0, Math.min(r, Math.min(w, h) / 2));
    ctx.beginPath();
    ctx.moveTo(x + rr, y);
    ctx.arcTo(x + w, y, x + w, y + h, rr);
    ctx.arcTo(x + w, y + h, x, y + h, rr);
    ctx.arcTo(x, y + h, x, y, rr);
    ctx.arcTo(x, y, x + w, y, rr);
    ctx.closePath();
  }

  /* è¿½åŠ ï¼šãƒ†ã‚­ã‚¹ãƒˆã®æŠ˜ã‚Šè¿”ã—ï¼ˆCanvasï¼‰ */
  function wrapTextLines(ctx, text, maxWidth){
    const words = String(text || "").split("");
    const lines = [];
    let line = "";
    for (const ch of words){
      const test = line + ch;
      if (ctx.measureText(test).width > maxWidth && line){
        lines.push(line);
        line = ch;
      }else{
        line = test;
      }
    }
    if (line) lines.push(line);
    return lines;
  }

  /* ============================
   * â˜…è¿½åŠ ï¼šã‚¤ãƒ©ã‚¹ãƒˆè¡¨ç¤ºï¼ˆassets/illust/{No}.pngï¼‰
   * ============================ */
  const ILLUST_BASE = "assets/illust/"; // â†ã“ã“å›ºå®š
  const ILLUST_EXT  = ".png";

  function setIllustrationByNo(no){
    const box = document.getElementById("illusBox");
    if (!box) return;

    const n = String(no == null ? "" : no).trim();

    // NoãŒç„¡ã„/ç©ºãªã‚‰ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€è¡¨ç¤º
    if (!n){
      box.textContent = "ILLUST";
      return;
    }

    // ãƒ‘ã‚¹ç”Ÿæˆï¼ˆä¾‹: assets/illust/12.pngï¼‰
    const src = ILLUST_BASE + encodeURIComponent(n) + ILLUST_EXT;

    // ã„ã£ãŸã‚“æ ã‚’ç©ºã«ã—ã¦ç”»åƒã‚’å·®ã—è¾¼ã‚€
    box.innerHTML = "";
    const img = document.createElement("img");
    img.alt = "è¨ºæ–­ã‚¤ãƒ©ã‚¹ãƒˆ";
    img.src = src;

    // ç”»åƒãŒ404ãªã‚‰ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ã«æˆ»ã™
    img.onerror = () => {
      box.textContent = "ILLUST";
    };

    box.appendChild(img);
  }

  /* è¿½åŠ ï¼š#shareTop ã‚’ â€œåŒã˜è¦‹ãŸç›®â€ ã§Canvasã«æç”»â†’PNGä¿å­˜ï¼ˆSafariã§ã‚‚å®‰å®šï¼‰ */
  async function saveShareTopImage(pos){
    setShotMsg(pos, "", "");

    const btn = document.getElementById(pos === "bottom" ? "shotBtnBottom" : "shotBtnTop");
    const otherBtn = document.getElementById(pos === "bottom" ? "shotBtnTop" : "shotBtnBottom");

    if (!btn) return;

    btn.disabled = true;
    if (otherBtn) otherBtn.disabled = true;
    btn.textContent = "ç”»åƒã‚’ä½œæˆä¸­â€¦";

    try{
      const shareTop = document.getElementById("shareTop");
      if (!shareTop) throw new Error("shareTop not found");

      // è¡¨ç¤ºä¸­ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—ï¼ˆæ¼ã‚Œãªã„ç¯„å›²ã®ã‚‚ã®ã ã‘ï¼‰
      const name = (document.getElementById("nameSpan")?.textContent || "ã‚ãªãŸ").trim();
      const prefix = (document.getElementById("prefixSpan")?.textContent || "").trim();
      const animal = (document.getElementById("animalSpan")?.textContent || "").trim();

      const rect = shareTop.getBoundingClientRect();
      const dpr = Math.max(1, window.devicePixelRatio || 1);

      // å‡ºåŠ›ã‚µã‚¤ã‚ºï¼ˆshareTopã«åˆã‚ã›ã‚‹ï¼‰
      const W = Math.max(320, Math.ceil(rect.width));
      const H = Math.max(140, Math.ceil(rect.height));

      const canvas = document.createElement("canvas");
      canvas.width = Math.ceil(W * dpr);
      canvas.height = Math.ceil(H * dpr);

      const ctx = canvas.getContext("2d");
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

      // èƒŒæ™¯ï¼ˆç™½ï¼‰
      ctx.fillStyle = "#ffffff";
      ctx.fillRect(0, 0, W, H);

      // shareTopã‚«ãƒ¼ãƒ‰
      const pad = 14;
      const radius = 18;
      const borderColor = "#f3d2c2";
      const shadowColor = "rgba(20,10,5,.05)";

      ctx.save();
      ctx.shadowColor = shadowColor;
      ctx.shadowBlur = 18;
      ctx.shadowOffsetX = 0;
      ctx.shadowOffsetY = 6;

      roundRectPath(ctx, 0, 0, W, H, radius);
      ctx.fillStyle = "rgba(255,255,255,.86)";
      ctx.fill();

      ctx.restore();

      roundRectPath(ctx, 0, 0, W, H, radius);
      ctx.strokeStyle = borderColor;
      ctx.lineWidth = 1;
      ctx.stroke();


// ===== ã“ã“ã‹ã‚‰å·®ã—æ›¿ãˆï¼ˆç¸¦ä¸¦ã³ãƒ»ä¸­å¤®ãƒ»æ¨ªå¹…ã„ã£ã±ã„ç”»åƒï¼‰ =====

// ã€Œã‚ãªãŸã•ã‚“ã¯ã€ã€(ä¸­å¤®)
ctx.fillStyle = "#2b2b2b";
ctx.textBaseline = "top";
ctx.font = "1000 18px ui-rounded, system-ui, -apple-system, 'Segoe UI', Roboto, 'Hiragino Maru Gothic ProN','Hiragino Kaku Gothic ProN','Noto Sans JP','Yu Gothic',sans-serif";
const whoText = `${name}ã•ã‚“ã¯ã€`;
const whoW = ctx.measureText(whoText).width;
ctx.fillText(whoText, (W - whoW)/2, pad);

let y = pad + 18 + 12; // whoã®ä¸‹

// ç”»åƒã‚¨ãƒªã‚¢ï¼ˆæ¨ªå¹…ã„ã£ã±ã„ï¼‰
const imgX = pad;
const imgW = W - pad*2;

// è¡¨ç¤ºå´CSSã® aspect-ratio ã¨åˆã‚ã›ã‚‹ï¼ˆ16/9 ãªã‚‰â†“ï¼‰
const imgH = Math.round(imgW * 1 / 1);

// è§’ä¸¸ã‚¯ãƒªãƒƒãƒ—ã—ã¦èƒŒæ™¯æç”»
ctx.save();
roundRectPath(ctx, imgX, y, imgW, imgH, 18);
ctx.fillStyle = "rgba(255,255,255,.6)";
ctx.fill();
ctx.clip();

// å®Ÿç”»åƒãŒã‚ã‚Œã°æç”»ï¼ˆcoverï¼‰
const illusImgEl = document.querySelector("#illusBox img");
const illusSrc = illusImgEl?.src || "";

if (illusSrc){
  const img = new Image();
  img.crossOrigin = "anonymous";
  await new Promise((resolve, reject) => {
    img.onload = resolve;
    img.onerror = reject;
    img.src = illusSrc;
  });

  const iw = img.naturalWidth || img.width;
  const ih = img.naturalHeight || img.height;

  const scale = Math.max(imgW / iw, imgH / ih);
  const dw = iw * scale;
  const dh = ih * scale;
  const dx = imgX + (imgW - dw) / 2;
  const dy = y + (imgH - dh) / 2;

  ctx.drawImage(img, dx, dy, dw, dh);
}else{
  // ç”»åƒãŒç„¡ã„å ´åˆã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ï¼ˆè–„ã„ãƒ†ã‚­ã‚¹ãƒˆï¼‰
  ctx.fillStyle = "rgba(156,163,175,.9)";
  ctx.font = "900 16px ui-rounded, system-ui, -apple-system, 'Segoe UI', Roboto, 'Noto Sans JP', sans-serif";
  const t = "ILLUST";
  const tw = ctx.measureText(t).width;
  ctx.fillText(t, imgX + (imgW - tw)/2, y + (imgH - 16)/2);
}
ctx.restore();

y += imgH + 12;

// çµæœãƒ†ã‚­ã‚¹ãƒˆï¼ˆä¸­å¤®æƒãˆãƒ»wrapï¼‰
ctx.fillStyle = "#2b2b2b";
ctx.font = "1100 22px ui-rounded, system-ui, -apple-system, 'Segoe UI', Roboto, 'Hiragino Maru Gothic ProN','Hiragino Kaku Gothic ProN','Noto Sans JP','Yu Gothic',sans-serif";

const main = `${prefix}${animal}ã§ã™ï¼`;
const lines = wrapTextLines(ctx, main, W - pad*2);
const lineH = 28;

for (let i=0;i<lines.length;i++){
  const line = lines[i];
  const lw = ctx.measureText(line).width;
  ctx.fillText(line, (W - lw)/2, y + i*lineH);
}

// ===== ã“ã“ã¾ã§å·®ã—æ›¿ãˆ =====


      // ãƒ•ã‚¡ã‚¤ãƒ«åï¼ˆsidãŒã‚ã‚Œã°å«ã‚ã‚‹ï¼‰
      const safeSid = (sessionId || "no-sid").replace(/[^\w\-]/g, "_");
      const fileName = `result_${safeSid}.png`;

      // ä¿å­˜ï¼ˆSafariã§ç¢ºå®Ÿã«å‹•ãæ‰‹é †ï¼štoBlobâ†’ObjectURLâ†’a.clickï¼‰
      const blob = await new Promise((resolve) => canvas.toBlob(resolve, "image/png"));
      if (!blob) throw new Error("toBlob failed");

      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = fileName;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(() => URL.revokeObjectURL(url), 1000);

      setShotMsg(pos, "ok", "ç”»åƒã‚’ä½œæˆã—ã¾ã—ãŸï¼ï¼ˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰/å…±æœ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ã”ç¢ºèªãã ã•ã„ï¼‰");

      btn.textContent = "ä¿å­˜ã—ã¾ã—ãŸ";
      btn.disabled = false;
      if (otherBtn) otherBtn.disabled = false;

    }catch(e){
      console.warn(e);
      setShotMsg(pos, "err", "ç”»åƒåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸï¼š" + (e && e.message ? e.message : "unknown error"));
      btn.disabled = false;
      if (otherBtn) otherBtn.disabled = false;
      btn.textContent = "çµæœã®éƒ¨åˆ†ã ã‘ã‚’ä¿å­˜ã™ã‚‹";
    }
  }

  async function loadResult(){
    setMsg("", "");
    showRetry(false);

    if (!sessionId){
      showLoading(false);
      setMsg("err", "ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±(sid)ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã—ã¦ãã ã•ã„ã€‚");
      showRetry(true);
      return;
    }

    showLoading(true);

    try{
      const data = await postToGAS({ action:"getResult", sessionId });

      if (!data || !data.ok){
        showLoading(false);
        setMsg("err", "çµæœã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
        showRetry(true);
        return;
      }

      if (!data.ready){
        showLoading(false);
        setMsg("err", "ã¾ã é›†è¨ˆãŒå®Œäº†ã—ã¦ã„ãªã„ã‚ˆã†ã§ã™ã€‚å°‘ã—å¾…ã£ã¦ã‹ã‚‰å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚");
        showRetry(true);
        return;
      }

      const r = data.result || {};

      // è¡¨ç¤º
      document.getElementById("nameSpan").textContent = r.name || "ã‚ãªãŸ";
      document.getElementById("prefixSpan").textContent = r.prefixGroup || "";
      document.getElementById("animalSpan").textContent = r.animalGroup || "";
      document.getElementById("topText").textContent = r.topText || "";

      // â˜…è¿½åŠ ï¼šã‚¤ãƒ©ã‚¹ãƒˆNoã§è¡¨ç¤ºï¼ˆassets/illust/{No}.pngï¼‰
      setIllustrationByNo(r.illusNo);

      renderSections(r);
            // setMosaic(true);



      document.getElementById("statusCard").style.display = "none";
      document.getElementById("resultCard").style.display = "block";
      showLoading(false);
      // No.7ï¼šä¿å­˜æ¸ˆã¿ãªã‚‰è‡ªå‹•è§£é™¤
try{
  const key = "unlocked_result_" + String(sessionId || "");
if (localStorage.getItem(key) === "1"){
    setMosaic(false);
    const box = document.getElementById("unlockBox");
    if (box) box.style.display = "none";
  }
}catch(e){}


    }catch(e){
      console.warn(e);
      showLoading(false);
      setMsg("err", "é€šä¿¡ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒãƒƒãƒˆç’°å¢ƒã‚’å¤‰ãˆã¦å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚");
      showRetry(true);
    }
  }

  async function sendEmail(){
    setEmailMsg("", "");

    if (!sessionId){
      setEmailMsg("err", "ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±(sid)ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
      return;
    }

    const email = (document.getElementById("emailInput").value || "").trim();
    if (!email){
      setEmailMsg("err", "ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
      return;
    }
    if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){
      setEmailMsg("err", "ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å½¢å¼ãŒæ­£ã—ããªã•ãã†ã§ã™ã€‚");
      return;
    }

    const btn = document.getElementById("sendBtn");
    btn.disabled = true;
    btn.textContent = "é€ä¿¡ä¸­â€¦";

    try{
      const data = await postToGAS({ action:"sendResultEmail", sessionId, email });

      if (!data || !data.ok){
        btn.disabled = false;
        btn.textContent = "ã“ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã«é€ä¿¡ã™ã‚‹";
        setEmailMsg("err", "é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ç½®ã„ã¦å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚");
        return;
      }

      if (data.alreadySent){
        btn.disabled = true;
        btn.textContent = "é€ä¿¡æ¸ˆã¿";
        setEmailMsg("ok", "ã™ã§ã«é€ä¿¡æ¸ˆã¿ã§ã™ï¼ˆé‡è¤‡é€ä¿¡ã¯ã—ã¾ã›ã‚“ï¼‰ã€‚");
        return;
      }

      if (data.sent){
        btn.disabled = true;
        btn.textContent = "é€ä¿¡å®Œäº†ï¼";
        setEmailMsg("ok", "é€ä¿¡ã—ã¾ã—ãŸã€‚ãƒ¡ãƒ¼ãƒ«ãƒœãƒƒã‚¯ã‚¹ã‚’ã”ç¢ºèªãã ã•ã„ã€‚");
        return;
      }

      // ã“ã“ã«æ¥ãŸã‚‰æƒ³å®šå¤–
      btn.disabled = false;
      btn.textContent = "ã“ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã«é€ä¿¡ã™ã‚‹";
      setEmailMsg("err", "é€ä¿¡çŠ¶æ…‹ãŒä¸æ˜ã§ã™ã€‚ã‚‚ã†ä¸€åº¦è©¦ã—ã¦ãã ã•ã„ã€‚");

    }catch(e){
      console.warn(e);
      btn.disabled = false;
      btn.textContent = "ã“ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã«é€ä¿¡ã™ã‚‹";
      setEmailMsg("err", "é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒãƒƒãƒˆç’°å¢ƒã‚’å¤‰ãˆã¦å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚");
    }
  }



  // ===== No.21 ä¿é™ºï¼šsendEmail ãŒæœªå®šç¾©ãªã‚‰ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã ã‘å‡ºã™ =====
if (typeof window.sendEmail !== "function"){
  window.sendEmail = function(){
    const el = document.getElementById("emailMsg");
    if (el) el.innerHTML = '<div class="err">é€ä¿¡æ©Ÿèƒ½ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆJSã‚¨ãƒ©ãƒ¼ã®å¯èƒ½æ€§ï¼‰ã€‚</div>';
  };
}

  // èµ·å‹•
  loadResult();
</script>
  <!-- ===== DMé·ç§»å‰ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— ===== -->
<div id="dmPopup" class="dmPopupOverlay" aria-hidden="true">
  <div class="dmPopupCard" role="dialog" aria-modal="true" aria-labelledby="dmPopupTitle">
    <p id="dmPopupTitle" class="dmPopupTitle">Instagramã¸ç§»å‹•ã—ã¾ã™</p>
    <p id="dmPopupText" class="dmPopupText"></p>
    <div class="dmPopupActions">
      <button id="dmPopupGo" class="dmPopupBtn primary" type="button">OKâœ¨</button>
    </div>
  </div>
</div>

</body>
</html>
