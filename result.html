<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="robots" content="noindex,nofollow" />
  <title>診断結果</title>

  <style>
    :root{
      --bg1:#fff7ef;
      --bg2:#fff1f6;
      --card:#ffffffcc;
      --text:#2b2b2b;
      --muted:#6b7280;
      --line:#f1d7c8;
      --shadow: 0 10px 30px rgba(20,10,5,.08);
      --shadow2: 0 6px 18px rgba(20,10,5,.06);
      --radius: 18px;
      --radius2: 14px;
      --accent:#ff7a59;
      --good1:#34d399;
      --good2:#22c55e;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-rounded, system-ui, -apple-system, "Segoe UI", Roboto,
        "Hiragino Maru Gothic ProN","Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic",sans-serif;
      background: radial-gradient(1200px 700px at 20% 10%, var(--bg2), transparent 60%),
                  radial-gradient(1200px 700px at 80% 0%, #fffbe6, transparent 55%),
                  linear-gradient(180deg, var(--bg1), #ffffff);
      color:var(--text);
    }
    .wrap{max-width:760px;margin:0 auto;padding:18px 14px 40px;}
.hero{
  padding:18px 16px;border:1px solid var(--line);border-radius:var(--radius);
  background:rgba(255,255,255,.78);box-shadow: var(--shadow);backdrop-filter: blur(10px);
  text-align:center;
}
    h1{font-size:22px;margin:0 0 8px;letter-spacing:.2px;}
    .sub{color:var(--muted);line-height:1.7;margin:0;}
    .card{
      margin-top:14px;padding:16px;border:1px solid var(--line);border-radius:var(--radius);
      background:rgba(255,255,255,.72);box-shadow: var(--shadow2);
    }
    .hr{height:1px;background: linear-gradient(90deg, transparent, var(--line), transparent);margin:14px 0;}
    .tiny{font-size:12px;color:var(--muted);line-height:1.7;margin-top:8px;}

    .ok{
      color:#064e3b;background: rgba(34,197,94,.10);
      border:1px solid rgba(34,197,94,.25);
      padding:10px;border-radius:var(--radius2);margin-top:10px;line-height:1.7;
    }
    .err{
      color:#7f1d1d;background: rgba(239,68,68,.08);
      border:1px solid rgba(239,68,68,.25);
      padding:10px;border-radius:var(--radius2);margin-top:10px;line-height:1.7;
    }

    /* ★ここだけが（将来スクショ対象にしたいなら）切り出しやすい */
    #shareTop{
      border:1px solid #f3d2c2;
      border-radius:var(--radius);
      padding:14px;
      background: rgba(255,255,255,.86);
      box-shadow: 0 6px 18px rgba(20,10,5,.05);
    }
    .who{
      font-size:18px;
      font-weight:1000;
      margin:0 0 10px;
      line-height:1.4;
    }
    .badgeRow{
      display:flex;
      flex-direction:column;
      gap:12px;
      align-items:center;
    }

    /* ★追加：イラスト枠そのもの（今まで無かったので追記が必要） */
    .illus{
      width:100%;
      height:auto;
      aspect-ratio: 1 / 1;   /* 横長。正方形が良ければ 1 / 1 */
      border:none;            /* 点線枠いらない */
      border-radius:18px;
      background: rgba(255,255,255,.6);
      overflow:hidden;
      display:block;
    }

    /* ★追加：イラスト画像表示用（枠内にぴったり収める） */
    .illus img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
  

    .typeBox{flex:1 1 auto;min-width:200px;}
    .typeMain{font-size:22px;font-weight:1100;margin:0 0 6px;letter-spacing:.2px;}
    .typeSub{margin:0;color:var(--muted);line-height:1.6;white-space:pre-wrap;}

    .sectionTitle{
      font-weight:1000;
      margin:0 0 8px;
      font-size:15px;
    }
    .text{
      white-space:pre-wrap;
      line-height:1.85;
      margin:0;
    }

    .field{
      width:100%;
      padding:12px;
      border-radius:var(--radius2);
      border:1px solid #f3d2c2;
      background:#fff;
      color:var(--text);
      font-size:16px;
    }

    .btn{
      appearance:none;
      border:1px solid #f3d2c2;
      background:#fff;
      color:var(--text);
      padding:12px 14px;
      border-radius:var(--radius2);
      font-weight:900;
      cursor:pointer;
      width:100%;
      box-shadow: 0 4px 12px rgba(20,10,5,.06);
      transition: transform .06s ease, box-shadow .2s ease, border-color .2s ease;
    }
    .btn:active{transform: translateY(1px);}
    .btn.good{
      background: linear-gradient(90deg, var(--good1), var(--good2));
      border-color: transparent;
      color:#0b2b1f;
    }
    .btn:disabled{opacity:.55;cursor:not-allowed}

    .loadingRow{
      display:flex;gap:10px;align-items:center;
      color:var(--muted);
      font-weight:900;
    }
    .spinner{
      width:18px;height:18px;border-radius:999px;
      border:3px solid rgba(0,0,0,.08);
      border-top-color: rgba(0,0,0,.35);
      animation: spin 0.9s linear infinite;
    }
    @keyframes spin{to{transform: rotate(360deg)}}

    /* 追加：スクショ（画像保存）ボタン周り */
        /* ===== 追加：モザイク（トップ文章より下をぼかす） ===== */
    #mosaicArea{
      position: relative;
    }
    #mosaicArea.isMosaic{
      filter: blur(10px);
      opacity: .9;
      pointer-events: none; /* ぼかし中は操作できない（解除後に操作OK） */
      user-select: none;
    }

    .shotBox{margin-top:10px;}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="hero">
      <h1>診断結果</h1>
    </div>

    <div class="card" id="statusCard">
      <div class="loadingRow" id="loadingRow">
        <div class="spinner"></div>
        <div>読み込み中…</div>
      </div>
      <div id="msg"></div>
      <div style="margin-top:12px;display:none;" id="retryBox">
        <button class="btn" onclick="loadResult()">もう一度読み込む</button>
        <div class="tiny">※集計がまだの場合、少し待ってから再読み込みしてください。</div>
      </div>
    </div>

    <div class="card" id="resultCard" style="display:none;">
      <!-- ★上部（あなたのフォーマット） -->
      <div id="shareTop">
        <p class="who"><span id="nameSpan">あなた</span>さんは、</p>
        <div class="badgeRow">
          <div class="illus" id="illusBox">ILLUST</div>
          <div class="typeBox">
            <p class="typeMain">
              <span id="prefixSpan">接頭語</span><span id="animalSpan">動物</span>
              です！
            </p>
          </div>
        </div>
      </div>

      <!-- 追加：ボタン（上側） -->
      <div class="shotBox">
        <button class="btn" id="shotBtnTop" onclick="saveShareTopImage('top')">結果の部分だけを保存する</button>
        <div class="tiny">※この部分から、性に関する回答内容が漏れる心配はありません。</div>
        <div id="shotMsgTop"></div>
      </div>

      <div class="hr"></div>

      <p class="text" id="topText"></p>


<!-- ===== 合言葉UI（モザイクの外：押せる状態） ===== -->
<div id="unlockBox" style="padding:12px;margin-bottom:12px;border:1px dashed #f3d2c2;border-radius:14px;background:rgba(255,255,255,.85);">
  <p class="sectionTitle">合言葉を入力してください</p>
  <input class="field" id="unlockInput" placeholder="合言葉を入力">
  <button class="btn" style="margin-top:8px;" onclick="tryUnlock()">合言葉で解除</button>
  <div class="tiny">※Instagram DMで受け取った合言葉を入力してください</div>
  <div id="unlockMsg"></div>
  <button class="btn" id="genKeyBtn" style="margin-top:10px;" onclick="generateKey()">
  初めての表示はこちら（合言葉を発行）
</button>

<div class="tiny">※このボタンは最初の1回だけ使います</div>
</div>

<!-- ===== ここから下だけモザイク（押せないのはここでOK） ===== -->
<div id="mosaicArea">
  <div class="hr"></div>

  <div id="sections"></div>

  <div class="hr"></div>

  <!-- メール送信ブロック -->
  <div>
    <p class="sectionTitle">この結果全文を、メールに送信します！</p>

    <div class="shotBox" style="margin-top:10px;">
      <button class="btn" id="inviteBtn" onclick="issueInviteUrl()">招待URLを発行</button>
      <div id="inviteMsg"></div>
    </div>

    <div class="shotBox" style="margin-top:10px;">
      <button class="btn" id="shotBtnBottom" onclick="saveShareTopImage('bottom')">結果の部分だけを保存する</button>
      <div class="tiny">※この部分から、性に関する回答内容が漏れる心配はありません。</div>
      <div id="shotMsgBottom"></div>
    </div>

    <input class="field" id="emailInput" type="email" inputmode="email" autocomplete="email" placeholder="メールアドレスを入力">
    <div class="tiny">※メールアドレスは、結果のメール送信以外には使用しません。</div>

    <button class="btn good" id="sendBtn" onclick="sendEmail()" style="margin-top:10px;">このアドレスに送信する</button>
    <div id="emailMsg"></div>
  </div>
</div>


    </div>
  </div>

<script>
  const GAS_URL = "https://script.google.com/macros/s/AKfycbz0nSbcIZKV6P3d8NPu1mZKRjVLT2EF6grR5nfc2otxiky6jdaRBiFhskvjoemWUlOn/exec";

  const params = new URLSearchParams(location.search);
  const sessionId = params.get("sid");

  const AXIS_TITLES = {
    A: "①思考・意思決定の深層スタイル",
    B: "②感情との距離感・扱い方",
    C: "③自己価値感・自己肯定の源泉",
    D: "④ストレス構造と回復パターン",
    E: "⑤対人関係・距離感のクセ",
    F: "⑥親密さ・恋愛における心理傾向",
    G: "⑦性と自己理解のつながり方",
    H: "⑧人生の進み方・停滞ポイント",
  };

  function escapeHtml(s){
    return String(s||"").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }
  function setMsg(kind, text){
    const el = document.getElementById("msg");
    if (!text){ el.innerHTML = ""; return; }
    el.innerHTML = `<div class="${kind === 'err' ? 'err' : 'ok'}">${escapeHtml(text)}</div>`;
  }
  function setEmailMsg(kind, text){
    const el = document.getElementById("emailMsg");
    if (!text){ el.innerHTML = ""; return; }
    el.innerHTML = `<div class="${kind === 'err' ? 'err' : 'ok'}">${escapeHtml(text)}</div>`;
  }

  /* 追加：スクショ保存メッセージ */
  function setShotMsg(pos, kind, text){
    const el = document.getElementById(pos === "bottom" ? "shotMsgBottom" : "shotMsgTop");
    if (!text){ el.innerHTML = ""; return; }
    el.innerHTML = `<div class="${kind === 'err' ? 'err' : 'ok'}">${escapeHtml(text)}</div>`;
  }
  /* 追加：招待URLメッセージ */
function setInviteMsg(kind, text){
  const el = document.getElementById("inviteMsg");
  if (!el) return;
  if (!text){ el.innerHTML = ""; return; }
  el.innerHTML = `<div class="${kind === 'err' ? 'err' : 'ok'}">${escapeHtml(text)}</div>`;
}

/* 追加：ランダム招待コード生成（短めで十分推測されにくい） */
function makeInviteCode(){
  // cryptoが使える環境なら強め、ダメならMath.randomでフォールバック
  if (window.crypto && crypto.getRandomValues){
    const bytes = new Uint8Array(12);
    crypto.getRandomValues(bytes);
    // URLに載せやすいbase36っぽい文字列へ
    return Array.from(bytes, b => (b % 36).toString(36)).join("");
  }
  return (Math.random().toString(36).slice(2) + Math.random().toString(36).slice(2)).slice(0, 18);
}

/* 追加：招待URL発行（1セッション1回っぽく見せる） */
async function issueInviteUrl(){
  setInviteMsg("", "");

  if (!sessionId){
    setInviteMsg("err", "セッション情報(sid)が見つかりません。");
    return;
  }

  const btn = document.getElementById("inviteBtn");
  if (!btn) return;

  // 発行済みチェック（厳密保証ではなく“見せ方”）
  const issuedKey = "inviteIssued_" + String(sessionId || "");
  const already = localStorage.getItem(issuedKey);
  if (already){
    btn.disabled = true;
    btn.textContent = "発行済み";
    setInviteMsg("ok", "このセッションでは招待URLは発行済みです。");
    return;
  }

  // 氏名入力（キャンセルなら中断）
  const inviterName = (window.prompt("氏名（フルネーム）を入力してください", "") || "").trim();
  if (!inviterName){
    setInviteMsg("err", "氏名が入力されなかったので中止しました。");
    return;
  }

  btn.disabled = true;
  btn.textContent = "発行中…";

  try{
    // 招待コード生成 & URL組み立て（同階層のindex.htmlへ）
    const inviteCode = makeInviteCode();
    const inviteUrl = new URL("index.html", location.href);
    inviteUrl.searchParams.set("invite", inviteCode);

    // クリップボードへコピー
    // ※Safariなどで失敗する場合に備えてフォールバックも用意
    try{
      await navigator.clipboard.writeText(inviteUrl.toString());
    }catch(_){
      const ta = document.createElement("textarea");
      ta.value = inviteUrl.toString();
      ta.style.position = "fixed";
      ta.style.left = "-9999px";
      document.body.appendChild(ta);
      ta.focus();
      ta.select();
      const ok = document.execCommand("copy");
      ta.remove();
      if (!ok) throw new Error("clipboard copy failed");
    }

    await postToGAS({
  action: "logInviteIssue",
  sessionId,
  inviterName,
  inviteCode,
  inviteUrl: inviteUrl.toString()
});

    // 発行済みとして保存（“見せ方”）
    localStorage.setItem(issuedKey, "1");


    btn.textContent = "コピーしました";
    btn.disabled = true;
    setInviteMsg("ok", "招待URLをコピーしました。貼り付けて共有できます。");

  }catch(e){
    console.warn(e);
    btn.disabled = false;
    btn.textContent = "招待URLを発行";
    setInviteMsg("err", "発行に失敗しました：" + (e && e.message ? e.message : "unknown error"));
  }
}


async function postToGAS(payloadObj){
  const maxTry = 5;
  for (let t=1; t<=maxTry; t++){
    try{
      const body = new URLSearchParams();
      body.set("payload", JSON.stringify(payloadObj));

      const res = await fetch(GAS_URL, {
        method: "POST",
        headers: {"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},
        body: body.toString(),
      });

      const text = await res.text();
      let json = {};
      try{ json = JSON.parse(text); }catch(_){}

      if (json && json.ok === false && json.error === "busy"){
        const wait = Number(json.retryAfterMs || 800);
        await new Promise(r => setTimeout(r, wait + Math.floor(Math.random()*200)));
        continue;
      }
      return json;

    }catch(err){
      if (t === maxTry) throw err;
      const backoff = Math.min(2000, 300 * (2 ** (t-1)));
      await new Promise(r => setTimeout(r, backoff + Math.floor(Math.random()*200)));
    }
  }
}


  function showLoading(on){
    document.getElementById("loadingRow").style.display = on ? "flex" : "none";
  }

  function showRetry(on){
    document.getElementById("retryBox").style.display = on ? "block" : "none";
  }
    // 追加：モザイクON/OFF（No.4はONにするだけ）
  function setMosaic(on){
    const area = document.getElementById("mosaicArea");
    if (!area) return;
    if (on) area.classList.add("isMosaic");
    else area.classList.remove("isMosaic");
  }
    // No.5 ダミー解除（まだ判定しない）
  function normalizeKey(s){
  return String(s || "")
    .toLowerCase()
    .replace(/\s+/g, ""); // 空白・改行すべて除去
}

const VALID_KEYS = [
  "j9aovb64",
  "dioap90h6",
  "ko99j7ftny"
];
  let issueKeyInFlight = false;

function openInstagramDM(igHandle, dmText){
  const shareUrl =
    "https://www.instagram.com/direct/new/?" +
    "text=" + encodeURIComponent(dmText) +
    "&username=" + encodeURIComponent(igHandle);

  let opened = false;
  try{
    const w = window.open(shareUrl, "_blank");
    opened = !!w;
  }catch(e){
    opened = false;
  }

  setTimeout(() => {
    if (opened) return;
    try{
      window.open(`https://www.instagram.com/direct/t/${igHandle}/`, "_blank");
    }catch(_){}
  }, 800);
}

async function copyToClipboard(text){
  try{
    await navigator.clipboard.writeText(text);
    return true;
  }catch(_){
    const ta = document.createElement("textarea");
    ta.value = text;
    ta.style.position = "fixed";
    ta.style.left = "-9999px";
    document.body.appendChild(ta);
    ta.focus();
    ta.select();
    const ok = document.execCommand("copy");
    ta.remove();
    return ok;
  }
}

  /* ===== REPLACE START: generateKey() ===== */
async function generateKey(){
  const msg = document.getElementById("unlockMsg");
  const btn = document.getElementById("genKeyBtn");

  // 連打ガード
  if (issueKeyInFlight) return;
  issueKeyInFlight = true;

  if (btn){
    btn.disabled = true;
    btn.textContent = "発行中…";
  }
  if (msg) msg.innerHTML = "合言葉を発行中…";

  try{
    if (!sessionId) throw new Error("sessionId がありません");

    const igHandle = "otona.shindan.321";
    const storedKeyK = "issued_key_" + String(sessionId || "");
    const storedTimeK = "issued_keyTime_" + String(sessionId || "");

    // 端末内に既発行があればそれを再利用（連打・再読み込み耐性）
    let key = "";
    let keyTime = "";
    try{
      key = (localStorage.getItem(storedKeyK) || "").trim();
      keyTime = (localStorage.getItem(storedTimeK) || "").trim();
    }catch(e){}

    // 無ければGASに発行依頼
    if (!key){
      const r = await postToGAS({ action: "issueKey", sessionId });
      if (!r || !r.ok){
        throw new Error((r && (r.error || r.message)) ? (r.error || r.message) : "issueKey failed");
      }
      key = String(r.key || "").trim();
      keyTime = String(r.keyTime || "").trim();

      try{
        localStorage.setItem(storedKeyK, key);
        if (keyTime) localStorage.setItem(storedTimeK, keyTime);
      }catch(e){}
    }

    const dmText = `【${key}】この文章をそのまま送ってください✨`;

    // コピー（失敗してもフォールバックあり）
    await copyToClipboard(dmText);

    // DM画面を開く（本文入りを試す→ダメなら通常DM）
    openInstagramDM(igHandle, dmText);

    // 表示（KeyはDM送信用。解除用ではない）
if (msg){
  msg.innerHTML =
    `DMに送る文章をコピーしました。Instagramに貼り付けて送信してください。` +
    (keyTime ? `<div class="tiny">（ログ用）発行時刻: ${escapeHtml_(keyTime)}</div>` : "");
}

    // ★解除用入力欄は空にする（ここに入れるのはインスタの自動返信キー）
const input = document.getElementById("unlockInput");
if (input) input.value = "";

  }catch(e){
    console.error(e);
    if (msg) msg.innerHTML = "合言葉の発行に失敗しました。もう一度お試しください。";

  }finally{
    issueKeyInFlight = false;
    if (btn){
      btn.disabled = false;
      btn.textContent = "初めての表示はこちら（合言葉を発行）";
    }
  }
}

/* ===== REPLACE END: generateKey() ===== */

// HTMLエスケープ（XSS対策の最低限）
function escapeHtml_(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#39;");
}
/* ===== /REPLACE END: generateKey() ===== */

function tryUnlock(){

  
  // ★ここに入れる（一番上）
  if (!sessionId){
    document.getElementById("unlockMsg").innerHTML =
      '<div class="err">セッション情報(sid)が見つかりません。</div>';
    return;
  }
  
  const raw = document.getElementById("unlockInput").value || "";
  const key = normalizeKey(raw);

  const ok = VALID_KEYS.includes(key);

  if (!ok){
    document.getElementById("unlockMsg").innerHTML =
      '<div class="err">合言葉が違います。</div>';
    return;
  }

  // 成功：モザイク解除
  // ★No.22 保険：CSSクラスだけじゃなくstyleでも強制解除
const area = document.getElementById("mosaicArea");
if (area){
  area.classList.remove("isMosaic");
  area.style.filter = "none";
  area.style.opacity = "1";
  area.style.pointerEvents = "auto";
}

  setMosaic(false);

  // 永続保存（この端末だけ）
  try{
    localStorage.setItem("unlocked_result_" + String(sessionId || ""), "1");
  }catch(e){}

// UI非表示（成功メッセージ不要）
const box = document.getElementById("unlockBox");
if (box) box.style.display = "none";
}




  function renderSections(result){
    const container = document.getElementById("sections");
    container.innerHTML = "";

    const items = [
      ["A", result.AText],
      ["B", result.BText],
      ["C", result.CText],
      ["D", result.DText],
      ["E", result.EText],
      ["F", result.FText],
      ["G", result.GText],
      ["H", result.HText],
    ];

    for (const [axis, text] of items){
      const card = document.createElement("div");
      card.style.marginTop = "12px";

      const title = document.createElement("p");
      title.className = "sectionTitle";
      title.textContent = AXIS_TITLES[axis] || axis;

      const p = document.createElement("p");
      p.className = "text";
      p.textContent = text || "";

      card.appendChild(title);
      card.appendChild(p);
      container.appendChild(card);
    }
  }

  /* 追加：角丸矩形（Canvas） */
  function roundRectPath(ctx, x, y, w, h, r){
    const rr = Math.max(0, Math.min(r, Math.min(w, h) / 2));
    ctx.beginPath();
    ctx.moveTo(x + rr, y);
    ctx.arcTo(x + w, y, x + w, y + h, rr);
    ctx.arcTo(x + w, y + h, x, y + h, rr);
    ctx.arcTo(x, y + h, x, y, rr);
    ctx.arcTo(x, y, x + w, y, rr);
    ctx.closePath();
  }

  /* 追加：テキストの折り返し（Canvas） */
  function wrapTextLines(ctx, text, maxWidth){
    const words = String(text || "").split("");
    const lines = [];
    let line = "";
    for (const ch of words){
      const test = line + ch;
      if (ctx.measureText(test).width > maxWidth && line){
        lines.push(line);
        line = ch;
      }else{
        line = test;
      }
    }
    if (line) lines.push(line);
    return lines;
  }

  /* ============================
   * ★追加：イラスト表示（assets/illust/{No}.png）
   * ============================ */
  const ILLUST_BASE = "assets/illust/"; // ←ここ固定
  const ILLUST_EXT  = ".png";

  function setIllustrationByNo(no){
    const box = document.getElementById("illusBox");
    if (!box) return;

    const n = String(no == null ? "" : no).trim();

    // Noが無い/空ならプレースホルダ表示
    if (!n){
      box.textContent = "ILLUST";
      return;
    }

    // パス生成（例: assets/illust/12.png）
    const src = ILLUST_BASE + encodeURIComponent(n) + ILLUST_EXT;

    // いったん枠を空にして画像を差し込む
    box.innerHTML = "";
    const img = document.createElement("img");
    img.alt = "診断イラスト";
    img.src = src;

    // 画像が404ならプレースホルダに戻す
    img.onerror = () => {
      box.textContent = "ILLUST";
    };

    box.appendChild(img);
  }

  /* 追加：#shareTop を “同じ見た目” でCanvasに描画→PNG保存（Safariでも安定） */
  async function saveShareTopImage(pos){
    setShotMsg(pos, "", "");

    const btn = document.getElementById(pos === "bottom" ? "shotBtnBottom" : "shotBtnTop");
    const otherBtn = document.getElementById(pos === "bottom" ? "shotBtnTop" : "shotBtnBottom");

    if (!btn) return;

    btn.disabled = true;
    if (otherBtn) otherBtn.disabled = true;
    btn.textContent = "画像を作成中…";

    try{
      const shareTop = document.getElementById("shareTop");
      if (!shareTop) throw new Error("shareTop not found");

      // 表示中のテキストを取得（漏れない範囲のものだけ）
      const name = (document.getElementById("nameSpan")?.textContent || "あなた").trim();
      const prefix = (document.getElementById("prefixSpan")?.textContent || "").trim();
      const animal = (document.getElementById("animalSpan")?.textContent || "").trim();

      const rect = shareTop.getBoundingClientRect();
      const dpr = Math.max(1, window.devicePixelRatio || 1);

      // 出力サイズ（shareTopに合わせる）
      const W = Math.max(320, Math.ceil(rect.width));
      const H = Math.max(140, Math.ceil(rect.height));

      const canvas = document.createElement("canvas");
      canvas.width = Math.ceil(W * dpr);
      canvas.height = Math.ceil(H * dpr);

      const ctx = canvas.getContext("2d");
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

      // 背景（白）
      ctx.fillStyle = "#ffffff";
      ctx.fillRect(0, 0, W, H);

      // shareTopカード
      const pad = 14;
      const radius = 18;
      const borderColor = "#f3d2c2";
      const shadowColor = "rgba(20,10,5,.05)";

      ctx.save();
      ctx.shadowColor = shadowColor;
      ctx.shadowBlur = 18;
      ctx.shadowOffsetX = 0;
      ctx.shadowOffsetY = 6;

      roundRectPath(ctx, 0, 0, W, H, radius);
      ctx.fillStyle = "rgba(255,255,255,.86)";
      ctx.fill();

      ctx.restore();

      roundRectPath(ctx, 0, 0, W, H, radius);
      ctx.strokeStyle = borderColor;
      ctx.lineWidth = 1;
      ctx.stroke();


// ===== ここから差し替え（縦並び・中央・横幅いっぱい画像） =====

// 「あなたさんは、」(中央)
ctx.fillStyle = "#2b2b2b";
ctx.textBaseline = "top";
ctx.font = "1000 18px ui-rounded, system-ui, -apple-system, 'Segoe UI', Roboto, 'Hiragino Maru Gothic ProN','Hiragino Kaku Gothic ProN','Noto Sans JP','Yu Gothic',sans-serif";
const whoText = `${name}さんは、`;
const whoW = ctx.measureText(whoText).width;
ctx.fillText(whoText, (W - whoW)/2, pad);

let y = pad + 18 + 12; // whoの下

// 画像エリア（横幅いっぱい）
const imgX = pad;
const imgW = W - pad*2;

// 表示側CSSの aspect-ratio と合わせる（16/9 なら↓）
const imgH = Math.round(imgW * 1 / 1);

// 角丸クリップして背景描画
ctx.save();
roundRectPath(ctx, imgX, y, imgW, imgH, 18);
ctx.fillStyle = "rgba(255,255,255,.6)";
ctx.fill();
ctx.clip();

// 実画像があれば描画（cover）
const illusImgEl = document.querySelector("#illusBox img");
const illusSrc = illusImgEl?.src || "";

if (illusSrc){
  const img = new Image();
  img.crossOrigin = "anonymous";
  await new Promise((resolve, reject) => {
    img.onload = resolve;
    img.onerror = reject;
    img.src = illusSrc;
  });

  const iw = img.naturalWidth || img.width;
  const ih = img.naturalHeight || img.height;

  const scale = Math.max(imgW / iw, imgH / ih);
  const dw = iw * scale;
  const dh = ih * scale;
  const dx = imgX + (imgW - dw) / 2;
  const dy = y + (imgH - dh) / 2;

  ctx.drawImage(img, dx, dy, dw, dh);
}else{
  // 画像が無い場合のプレースホルダ（薄いテキスト）
  ctx.fillStyle = "rgba(156,163,175,.9)";
  ctx.font = "900 16px ui-rounded, system-ui, -apple-system, 'Segoe UI', Roboto, 'Noto Sans JP', sans-serif";
  const t = "ILLUST";
  const tw = ctx.measureText(t).width;
  ctx.fillText(t, imgX + (imgW - tw)/2, y + (imgH - 16)/2);
}
ctx.restore();

y += imgH + 12;

// 結果テキスト（中央揃え・wrap）
ctx.fillStyle = "#2b2b2b";
ctx.font = "1100 22px ui-rounded, system-ui, -apple-system, 'Segoe UI', Roboto, 'Hiragino Maru Gothic ProN','Hiragino Kaku Gothic ProN','Noto Sans JP','Yu Gothic',sans-serif";

const main = `${prefix}${animal}です！`;
const lines = wrapTextLines(ctx, main, W - pad*2);
const lineH = 28;

for (let i=0;i<lines.length;i++){
  const line = lines[i];
  const lw = ctx.measureText(line).width;
  ctx.fillText(line, (W - lw)/2, y + i*lineH);
}

// ===== ここまで差し替え =====


      // ファイル名（sidがあれば含める）
      const safeSid = (sessionId || "no-sid").replace(/[^\w\-]/g, "_");
      const fileName = `result_${safeSid}.png`;

      // 保存（Safariで確実に動く手順：toBlob→ObjectURL→a.click）
      const blob = await new Promise((resolve) => canvas.toBlob(resolve, "image/png"));
      if (!blob) throw new Error("toBlob failed");

      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = fileName;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(() => URL.revokeObjectURL(url), 1000);

      setShotMsg(pos, "ok", "画像を作成しました！（ダウンロード/共有メニューをご確認ください）");

      btn.textContent = "保存しました";
      btn.disabled = false;
      if (otherBtn) otherBtn.disabled = false;

    }catch(e){
      console.warn(e);
      setShotMsg(pos, "err", "画像化に失敗しました：" + (e && e.message ? e.message : "unknown error"));
      btn.disabled = false;
      if (otherBtn) otherBtn.disabled = false;
      btn.textContent = "結果の部分だけを保存する";
    }
  }

  async function loadResult(){
    setMsg("", "");
    showRetry(false);

    if (!sessionId){
      showLoading(false);
      setMsg("err", "セッション情報(sid)が見つかりません。最初からやり直してください。");
      showRetry(true);
      return;
    }

    showLoading(true);

    try{
      const data = await postToGAS({ action:"getResult", sessionId });

      if (!data || !data.ok){
        showLoading(false);
        setMsg("err", "結果の取得に失敗しました。");
        showRetry(true);
        return;
      }

      if (!data.ready){
        showLoading(false);
        setMsg("err", "まだ集計が完了していないようです。少し待ってから再読み込みしてください。");
        showRetry(true);
        return;
      }

      const r = data.result || {};

      // 表示
      document.getElementById("nameSpan").textContent = r.name || "あなた";
      document.getElementById("prefixSpan").textContent = r.prefixGroup || "";
      document.getElementById("animalSpan").textContent = r.animalGroup || "";
      document.getElementById("topText").textContent = r.topText || "";

      // ★追加：イラストNoで表示（assets/illust/{No}.png）
      setIllustrationByNo(r.illusNo);

      renderSections(r);
            setMosaic(true);


      document.getElementById("statusCard").style.display = "none";
      document.getElementById("resultCard").style.display = "block";
      showLoading(false);
      // No.7：保存済みなら自動解除
try{
  const key = "unlocked_result_" + String(sessionId || "");
if (localStorage.getItem(key) === "1"){
    setMosaic(false);
    const box = document.getElementById("unlockBox");
    if (box) box.style.display = "none";
  }
}catch(e){}


    }catch(e){
      console.warn(e);
      showLoading(false);
      setMsg("err", "通信でエラーが発生しました。ネット環境を変えて再試行してください。");
      showRetry(true);
    }
  }

  async function sendEmail(){
    setEmailMsg("", "");

    if (!sessionId){
      setEmailMsg("err", "セッション情報(sid)が見つかりません。");
      return;
    }

    const email = (document.getElementById("emailInput").value || "").trim();
    if (!email){
      setEmailMsg("err", "メールアドレスを入力してください。");
      return;
    }
    if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){
      setEmailMsg("err", "メールアドレスの形式が正しくなさそうです。");
      return;
    }

    const btn = document.getElementById("sendBtn");
    btn.disabled = true;
    btn.textContent = "送信中…";

    try{
      const data = await postToGAS({ action:"sendResultEmail", sessionId, email });

      if (!data || !data.ok){
        btn.disabled = false;
        btn.textContent = "このアドレスに送信する";
        setEmailMsg("err", "送信に失敗しました。時間を置いて再試行してください。");
        return;
      }

      if (data.alreadySent){
        btn.disabled = true;
        btn.textContent = "送信済み";
        setEmailMsg("ok", "すでに送信済みです（重複送信はしません）。");
        return;
      }

      if (data.sent){
        btn.disabled = true;
        btn.textContent = "送信完了！";
        setEmailMsg("ok", "送信しました。メールボックスをご確認ください。");
        return;
      }

      // ここに来たら想定外
      btn.disabled = false;
      btn.textContent = "このアドレスに送信する";
      setEmailMsg("err", "送信状態が不明です。もう一度試してください。");

    }catch(e){
      console.warn(e);
      btn.disabled = false;
      btn.textContent = "このアドレスに送信する";
      setEmailMsg("err", "通信エラーが発生しました。ネット環境を変えて再試行してください。");
    }
  }



  // ===== No.21 保険：sendEmail が未定義ならエラー表示だけ出す =====
if (typeof window.sendEmail !== "function"){
  window.sendEmail = function(){
    const el = document.getElementById("emailMsg");
    if (el) el.innerHTML = '<div class="err">送信機能の読み込みに失敗しました（JSエラーの可能性）。</div>';
  };
}

  // 起動
  loadResult();
</script>
</body>
</html>
